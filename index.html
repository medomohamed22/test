<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Pi Vault - Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø°ÙƒÙŠØ©</title>

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700;800&display=swap" rel="stylesheet">
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* ØªÙ… Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø£Ù†ÙŠÙ‚ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¨Ø³ÙŠØ·Ø© */
    :root{
      --p:#7c3aed; --p2:#4c1d95; --bg:#0b0b14; --card:rgba(255,255,255,.06);
      --text:#f6f2ff; --muted:rgba(246,242,255,.72); --good:#10b981; --bad:#ef4444;
      --warn:#f59e0b; --shadow: 0 18px 60px rgba(0,0,0,.42); --r:22px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family:'Tajawal', sans-serif; color:var(--text);
      background: radial-gradient(900px 520px at 12% 0%, rgba(124,58,237,.35), transparent 60%), var(--bg);
      overflow-x:hidden; direction: rtl;
    }
    .wrap{ width:min(480px, 100%); margin:0 auto; padding: 20px 14px; }
    .panel{ background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.1); border-radius: var(--r); padding: 20px; margin-bottom: 15px; }
    .hero{ text-align: center; background: linear-gradient(135deg, var(--p), var(--p2)); color: white; }
    .balNum{ font-size: 48px; font-weight: 900; margin: 10px 0; }
    input{ width:100%; padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,.1); background: rgba(0,0,0,0.2); color: white; margin-bottom: 10px; text-align: center; }
    button{ width:100%; padding: 15px; border-radius: 12px; border: none; font-weight: 800; cursor: pointer; transition: 0.3s; }
    .btnPrimary{ background: #facc15; color: #000; }
    .btnPrimary:active{ transform: scale(0.98); }
    .userPill{ display: inline-flex; align-items: center; background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 20px; font-size: 14px; }
    .histItem{ display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .plus{ color: var(--good); } .minus{ color: var(--bad); }
  </style>
</head>

<body>
  <div class="wrap">
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div style="font-weight: 900; font-size: 20px;">Ï€ Pi Vault</div>
        <div id="user-display" class="userPill" style="display: none;">
            <span id="u-name"></span>
        </div>
    </div>

    <div id="login-box" class="panel" style="text-align: center;">
      <h2 style="margin-top:0;">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</h2>
      <p style="color: var(--muted);">ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ØªØµÙØ­ Pi</p>
      <button class="btnPrimary" onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>

    <div id="app" style="display:none;">
      <div class="panel hero">
        <div style="font-size: 14px; opacity: 0.8;">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ù…ØªÙˆÙØ± ÙÙŠ Vault</div>
        <div class="balNum" id="user-balance">0.00</div>
        <div style="font-size: 12px; font-family: monospace;" id="last-tx">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      </div>

      <div class="panel">
        <h3 style="margin-top:0;">ğŸ“¥ Ø¥ÙŠØ¯Ø§Ø¹ (Donation)</h3>
        <input type="number" id="dep-amount" placeholder="0.00" step="0.01">
        <button class="btnPrimary" id="btn-dep" onclick="deposit()">ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¢Ù†</button>
      </div>

      <div class="panel">
        <h3 style="margin-top:0;">ğŸ“¤ Ø³Ø­Ø¨ (Withdraw)</h3>
        <input type="text" id="with-address" placeholder="G... (Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙØ¸ØªÙƒ)">
        <input type="number" id="with-amount" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ï€">
        <button style="background: rgba(255,255,255,0.1); color: white;" id="btn-with" onclick="withdraw()">Ø·Ù„Ø¨ Ø³Ø­Ø¨</button>
      </div>

      <div class="panel">
        <h3 style="margin-top:0;">ğŸ•’ Ø¢Ø®Ø± Ø§Ù„Ø­Ø±ÙƒØ§Øª</h3>
        <div id="history-box"></div>
      </div>
    </div>
  </div>

<script>
  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase
  const SUPABASE_URL = 'https://xncapmzlwuisupkjlftb.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_zPECXAiI_bDbeLtRYe3vIw_IEt_p_AS';
  const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let currentUser = null;

  // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©
  async function login() {
    try {
      const Pi = window.Pi;
      if (!Pi) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ÙØªØ­ Ù…Ù† Ø¯Ø§Ø®Ù„ Pi Browser");

      Pi.init({ version: "2.0" });
      
      const auth = await Pi.authenticate(['username', 'payments'], onIncompletePaymentFound);
      currentUser = auth.user;

      document.getElementById("login-box").style.display = "none";
      document.getElementById("app").style.display = "block";
      document.getElementById("user-display").style.display = "inline-flex";
      document.getElementById("u-name").innerText = "@" + currentUser.username;

      refreshData();
    } catch (e) {
      console.error(e);
      alert("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + e.message);
    }
  }

  // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ§Ù„Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ (Ù…Ø±Ø¨ÙˆØ·Ø© Ø¨Ù€ donations Ùˆ withdrawals)
  async function refreshData() {
    if (!currentUser) return;

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹Ø§Øª
    const { data: donations } = await _supabase.from('donations').select('*').eq('pi_user_id', currentUser.uid);
    // Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª
    const { data: withdrawals } = await _supabase.from('withdrawals').select('*').eq('pi_user_id', currentUser.uid);

    const totalIn = donations?.reduce((sum, item) => sum + parseFloat(item.amount), 0) || 0;
    const totalOut = withdrawals?.reduce((sum, item) => sum + parseFloat(item.amount), 0) || 0;
    const balance = totalIn - totalOut;

    document.getElementById("user-balance").innerText = balance.toFixed(2);

    // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø³Ø¬Ù„
    const combined = [
      ...(donations || []).map(d => ({ ...d, type: 'in' })),
      ...(withdrawals || []).map(w => ({ ...w, type: 'out' }))
    ].sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).slice(0, 6);

    const box = document.getElementById("history-box");
    box.innerHTML = combined.map(h => `
      <div class="histItem">
        <span>${h.type === 'in' ? 'ğŸ“¥ Ø¥ÙŠØ¯Ø§Ø¹' : 'ğŸ“¤ Ø³Ø­Ø¨'}</span>
        <span class="${h.type === 'in' ? 'plus' : 'minus'}">${h.type === 'in' ? '+' : '-'}${parseFloat(h.amount).toFixed(2)}</span>
      </div>
    `).join('') || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø­Ø§Ù„ÙŠØ§Ù‹";
  }

  // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ (ØªØ³Ø¬Ù„ ÙÙŠ Ø¬Ø¯ÙˆÙ„ donations)
  async function deposit() {
    const amt = parseFloat(document.getElementById("dep-amount").value);
    if (!amt || amt <= 0) return alert("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");

    const btn = document.getElementById("btn-dep");
    btn.disabled = true;
    btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø­ÙØ¸Ø©...";

    try {
      const payment = await Pi.createPayment({
        amount: amt,
        memo: "Vault Deposit",
        metadata: { action: "deposit" }
      }, {
        onReadyForServerApproval: (id) => {
          return fetch('/api/pi/approve', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ paymentId: id })
          }).then(res => res.json());
        },
        onReadyForServerCompletion: async (id, txid) => {
          // ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Supabase ÙÙˆØ±Ø§Ù‹ ÙÙŠ Ø¬Ø¯ÙˆÙ„ donations
          await _supabase.from('donations').insert([{ 
            pi_user_id: currentUser.uid, 
            username: currentUser.username, 
            amount: amt,
            payment_id: id 
          }]);

          await fetch('/api/pi/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ paymentId: id, txid: txid })
          });

          alert("ØªÙ… Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ ÙˆØªØ³Ø¬ÙŠÙ„Ù‡ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!");
          document.getElementById("dep-amount").value = "";
          refreshData();
          btn.disabled = false;
          btn.innerText = "Ø¥ÙŠØ¯Ø§Ø¹ Ø§Ù„Ø¢Ù†";
        },
        onCancel: () => { btn.disabled = false; btn.innerText = "Ø¥ÙŠØ¯Ø§Ø¹ Ø§Ù„Ø¢Ù†"; },
        onError: () => { btn.disabled = false; btn.innerText = "Ø¥ÙŠØ¯Ø§Ø¹ Ø§Ù„Ø¢Ù†"; }
      });
    } catch (e) {
      btn.disabled = false;
      btn.innerText = "Ø¥ÙŠØ¯Ø§Ø¹ Ø§Ù„Ø¢Ù†";
    }
  }

  // Ø¯Ø§Ù„Ø© Ø§Ù„Ø³Ø­Ø¨ (ØªØ³Ø¬Ù„ ÙÙŠ Ø¬Ø¯ÙˆÙ„ withdrawals)
  async function withdraw() {
    const addr = document.getElementById("with-address").value;
    const amt = parseFloat(document.getElementById("with-amount").value);
    const balance = parseFloat(document.getElementById("user-balance").innerText);

    if (!addr || !amt || amt <= 0) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    if (amt > balance) return alert("Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ");

    try {
      // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø­Ø¨ ÙÙŠ Ø¬Ø¯ÙˆÙ„ withdrawals
      const { error } = await _supabase.from('withdrawals').insert([{ 
        pi_user_id: currentUser.uid, 
        username: currentUser.username, 
        amount: amt,
        wallet_address: addr
      }]);

      if (error) throw error;

      // Ø·Ù„Ø¨ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙØ¹Ù„ÙŠ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
      await fetch('/api/withdraw', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ uid: currentUser.uid, amount: amt, address: addr })
      });

      alert("ØªÙ… Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­!");
      refreshData();
    } catch (e) {
      alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø³Ø­Ø¨");
    }
  }

  async function onIncompletePaymentFound(payment) {
    await fetch('/api/pi/complete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ paymentId: payment.identifier, txid: payment.transaction.txid })
    });
  };
</script>
</body>
</html>

