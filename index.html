<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pi City Life RPG</title>
    
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --primary: #6b3484; /* Ù„ÙˆÙ† Pi Ø§Ù„Ù…Ù…ÙŠØ² */
            --gold: #fbce27;
            --bg: #121212;
            --panel: rgba(30, 30, 30, 0.9);
        }
        
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; }
        
        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        #login-screen {
            position: fixed; inset: 0; z-index: 999;
            background: linear-gradient(135deg, #2c0b36, #000);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        
        .btn-start {
            background: var(--gold); color: #000; border: none; padding: 15px 40px;
            font-size: 1.2rem; border-radius: 50px; cursor: pointer; font-weight: bold;
            box-shadow: 0 0 20px rgba(251, 206, 39, 0.5); transition: 0.3s;
        }
        .btn-start:hover { transform: scale(1.1); }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© (HUD) */
        #ui-layer {
            position: absolute; top: 0; left: 0; right: 0; padding: 15px;
            display: flex; justify-content: space-between; pointer-events: none;
        }
        
        .hud-box {
            background: var(--panel); padding: 10px 20px; border-radius: 12px;
            border: 1px solid var(--primary); pointer-events: auto;
            display: flex; gap: 15px; align-items: center;
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */
        #controls {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px; pointer-events: auto;
        }
        
        .action-btn {
            background: #333; color: white; border: 1px solid #555;
            padding: 10px 20px; border-radius: 8px; cursor: pointer;
        }
        .btn-buy { background: var(--primary); border-color: var(--gold); }

        canvas { display: block; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 style="color: var(--gold); font-size: 2.5rem;">Pi Life RPG</h1>
        <p>Ø¹Ø§Ù„Ù…Ùƒ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø§Ù„Ù…Ø±Ø¨ÙˆØ· Ø¨Ù€ Pi Network</p>
        <br>
        <button class="btn-start" onclick="login()">Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ</button>
    </div>

    <div id="ui-layer" class="hidden">
        <div class="hud-box">
            <span>ğŸ‘¤ <b id="ui-name">...</b></span>
            <span>â­ Lvl: <b id="ui-lvl">1</b></span>
        </div>
        <div class="hud-box">
            <span>ğŸ’° <b id="ui-assets">0</b> Ø¹Ù‚Ø§Ø±Ø§Øª</span>
        </div>
    </div>

    <div id="controls" class="hidden">
        <button class="action-btn" onclick="train()">ğŸ“š ØªØ¹Ù„Ù… (+XP)</button>
        <button class="action-btn btn-buy" onclick="buyHouse()">ğŸ  Ø´Ø±Ø§Ø¡ Ù…Ù†Ø²Ù„ (1 Pi)</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        // --- 1. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---
        const SUPABASE_URL = 'https://xncapmzlwuisupkjlftb.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_zPECXAiI_bDbeLtRYe3vIw_IEt_p_AS';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Sandbox Ù„Ù„ØªØ¬Ø±Ø¨Ø© (Ø§Ø¬Ø¹Ù„Ù‡ false Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ)
        const Pi = window.Pi;
        Pi.init({ version: "2.0", sandbox: false });

        let userState = null;

        // --- 2. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ---
        async function login() {
            try {
                const scopes = ['username', 'payments'];
                const authResult = await Pi.authenticate(scopes, onIncompletePayment);
                
                const username = authResult.user.username;
                console.log("Logged in as:", username);

                // Ø¬Ù„Ø¨ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                let { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('username', username)
                    .single();

                if (!data) {
                    const { data: newUser } = await supabase
                        .from('profiles')
                        .insert([{ username: username }])
                        .select()
                        .single();
                    userState = newUser;
                } else {
                    userState = data;
                }

                // Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('ui-layer').classList.remove('hidden');
                document.getElementById('controls').classList.remove('hidden');
                updateUI();
                startGameLoop();

            } catch (err) {
                alert("Ø®Ø·Ø£: ÙŠØ±Ø¬Ù‰ ÙØªØ­ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ù† Ù…ØªØµÙØ­ Pi Browser.");
                console.error(err);
            }
        }

        // --- 3. Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª (Pi SDK Full Flow) ---
        async function buyHouse() {
            if(!userState) return;

            const paymentData = {
                amount: 1, // Ø§Ù„Ø³Ø¹Ø± 1 Pi
                memo: "Ø´Ø±Ø§Ø¡ Ù…Ù†Ø²Ù„ Ø§ÙØªØ±Ø§Ø¶ÙŠ - Level 1", 
                metadata: { type: "house_asset" }
            };

            const callbacks = {
                onReadyForServerApproval: async (paymentId) => {
                    console.log("Approving:", paymentId);
                    await fetch('/api/pi/approve', {
                        method: 'POST',
                        body: JSON.stringify({ paymentId })
                    });
                },
                onReadyForServerCompletion: async (paymentId, txid) => {
                    console.log("Completing:", txid);
                    await fetch('/api/pi/complete', {
                        method: 'POST',
                        body: JSON.stringify({ paymentId, txid })
                    });
                    
                    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù†Ø§Ø¬Ø­
                    const currentAssets = userState.assets || [];
                    currentAssets.push({ type: 'house', date: new Date() });
                    
                    const { data } = await supabase
                        .from('profiles')
                        .update({ assets: currentAssets })
                        .eq('username', userState.username)
                        .select()
                        .single();
                        
                    userState = data;
                    updateUI();
                    alert("ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! ØªÙ… Ø´Ø±Ø§Ø¡ Ø§Ù„Ù…Ù†Ø²Ù„ Ø¨Ù†Ø¬Ø§Ø­.");
                },
                onCancel: (paymentId) => { console.log("Cancelled", paymentId); },
                onError: (error, payment) => { console.error("Error", error); }
            };

            try {
                await Pi.createPayment(paymentData, callbacks);
            } catch(e) {
                console.error(e);
            }
        }

        function onIncompletePayment(payment) {
            console.log("Incomplete Payment Found:", payment);
            // Ù…Ù†Ø·Ù‚ Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù‚Ø©
        }

        // --- 4. Ù…Ù†Ø·Ù‚ Ø§Ù„Ù„Ø¹Ø¨Ø© (Game Logic) ---
        async function train() {
            // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø®Ø¨Ø±Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ Ø«Ù… Ø­ÙØ¸Ù‡Ø§
            userState.xp += 10;
            if(userState.xp >= 100) {
                userState.level += 1;
                userState.xp = 0;
                alert("Level Up! â¬†ï¸");
            }
            updateUI();
            
            // Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© (Debounced in real app)
            await supabase
                .from('profiles')
                .update({ xp: userState.xp, level: userState.level })
                .eq('username', userState.username);
        }

        function updateUI() {
            document.getElementById('ui-name').innerText = userState.username;
            document.getElementById('ui-lvl').innerText = userState.level;
            document.getElementById('ui-assets').innerText = userState.assets ? userState.assets.length : 0;
        }

        // --- 5. Ø§Ù„Ø±Ø³ÙˆÙ…ÙŠØ§Øª (Canvas Render) ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.onresize = resize;
        resize();

        let player = { x: window.innerWidth/2, y: window.innerHeight/2 };

        function startGameLoop() {
            function draw() {
                // Ù…Ø³Ø­ Ø§Ù„Ø´Ø§Ø´Ø©
                ctx.fillStyle = "#121212";
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Ø±Ø³Ù… Ø£Ø±Ø¶ÙŠØ© Ø´Ø¨ÙƒÙŠØ© (Isometric Grid Effect)
                ctx.strokeStyle = "#333";
                ctx.beginPath();
                for(let i=0; i<canvas.width; i+=50) { ctx.moveTo(i,0); ctx.lineTo(i,canvas.height); }
                for(let i=0; i<canvas.height; i+=50) { ctx.moveTo(0,i); ctx.lineTo(canvas.width,i); }
                ctx.stroke();

                // Ø±Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨
                ctx.beginPath();
                ctx.arc(player.x, player.y, 25, 0, Math.PI*2);
                ctx.fillStyle = "#6b3484"; // Pi Purple
                ctx.fill();
                ctx.lineWidth = 3;
                ctx.strokeStyle = "#fbce27"; // Gold border
                ctx.stroke();

                // Ø±Ø³Ù… Ø§Ù„Ù…Ù†Ø²Ù„ Ø¥Ø°Ø§ Ø§Ø´ØªØ±Ø§Ù‡ Ø§Ù„Ù„Ø§Ø¹Ø¨
                if(userState.assets && userState.assets.length > 0) {
                    ctx.fillStyle = "#4CAF50";
                    ctx.fillRect(player.x + 50, player.y - 50, 40, 40);
                    ctx.fillStyle = "white";
                    ctx.font = "10px Arial";
                    ctx.fillText("Ù…Ù†Ø²Ù„ÙŠ", player.x + 55, player.y - 60);
                }

                // Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨
                ctx.fillStyle = "white";
                ctx.font = "bold 14px Arial";
                ctx.textAlign = "center";
                ctx.fillText(userState.username, player.x, player.y - 35);

                requestAnimationFrame(draw);
            }
            draw();
        }

        // ØªØ­Ø±ÙŠÙƒ Ø¨Ø³ÙŠØ· Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø±
        canvas.addEventListener('click', (e) => {
            player.x = e.clientX;
            player.y = e.clientY;
        });
    </script>
</body>
</html>
