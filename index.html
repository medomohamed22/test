<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Donate Way Wallet - Ù…Ø­ÙØ¸Ø© Ø­ÙØ¸ Ï€</title>

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700&display=swap" rel="stylesheet">
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --p:#8e44ad;
      --p2:#a29bfe;
      --bg1:#0b1020;
      --bg2:#121a33;
      --card: rgba(255,255,255,.08);
      --card2: rgba(255,255,255,.12);
      --text:#f4f5ff;
      --muted: rgba(244,245,255,.70);
      --line: rgba(255,255,255,.16);
      --good:#2ecc71;
      --bad:#ff5d5d;
      --shadow: 0 25px 60px rgba(0,0,0,.35);
      --radius: 26px;
    }

    *{box-sizing:border-box; margin:0; padding:0; font-family:'Tajawal', sans-serif;}
    body{
      min-height:100vh;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 85% 10%, rgba(142,68,173,.35), transparent 60%),
        radial-gradient(900px 600px at 10% 85%, rgba(162,155,254,.25), transparent 60%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    /* Topbar */
    header{
      position:sticky;
      top:0;
      z-index:9999;
      backdrop-filter: blur(18px);
      background: rgba(10,14,28,.55);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .topbar{
      max-width:1100px;
      margin:0 auto;
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      cursor:pointer;
      user-select:none;
    }
    .brand .mark{
      width:42px; height:42px; border-radius:14px;
      background: linear-gradient(135deg, rgba(142,68,173,1), rgba(162,155,254,1));
      box-shadow: 0 12px 30px rgba(142,68,173,.35);
      display:grid; place-items:center;
      font-weight:900;
    }
    .brand .t{
      display:flex; flex-direction:column; line-height:1.1;
    }
    .brand .t b{font-size:16px;}
    .brand .t span{font-size:12px; color:var(--muted);}

    .actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      display:none;
      padding:10px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      font-weight:700;
      max-width: 55vw;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .btn{
      border:none;
      cursor:pointer;
      padding:10px 14px;
      border-radius:999px;
      font-weight:800;
      transition:.2s;
      display:inline-flex;
      align-items:center;
      gap:8px;
      color:var(--text);
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.14);}
    .btn.primary{
      background: linear-gradient(135deg, rgba(142,68,173,1), rgba(162,155,254,1));
      border:none;
      box-shadow: 0 18px 35px rgba(142,68,173,.30);
    }
    .btn.primary:hover{filter:brightness(1.02);}
    .btn.danger{
      background: rgba(255,93,93,.16);
      border:1px solid rgba(255,93,93,.25);
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      transform:none;
    }

    /* Layout */
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:22px 16px 40px;
    }

    .hero{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:18px;
      align-items:stretch;
    }
    @media (max-width: 920px){
      .hero{grid-template-columns:1fr; }
    }

    .card{
      background: var(--card);
      border:1px solid rgba(255,255,255,.12);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-2px;
      background: radial-gradient(600px 200px at 80% 0%, rgba(162,155,254,.22), transparent 60%),
                  radial-gradient(600px 200px at 10% 100%, rgba(142,68,173,.18), transparent 60%);
      pointer-events:none;
    }
    .card > *{position:relative;}

    .card-h{
      padding:18px 18px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .card-h .title{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .card-h .title b{font-size:16px;}
    .card-h .title span{font-size:12px; color:var(--muted);}
    .badge{
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      color:var(--muted);
      font-size:12px;
      font-weight:800;
    }

    .card-b{
      padding:18px;
    }

    /* Wallet big balance */
    .balance{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .balance .num{
      font-size:44px;
      font-weight:900;
      letter-spacing:.5px;
      line-height:1.1;
      background: linear-gradient(135deg, #ffffff, rgba(162,155,254,.95));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }
    .balance .sub{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      color:var(--muted);
      font-size:13px;
    }
    .kv{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:16px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
    }

    /* Forms */
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media(max-width: 700px){
      .grid2{grid-template-columns:1fr;}
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    label{
      font-size:12px;
      color:var(--muted);
      font-weight:700;
    }
    input{
      width:100%;
      padding:14px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      outline:none;
      background: rgba(5,8,18,.35);
      color:var(--text);
      font-size:15px;
    }
    input::placeholder{color: rgba(244,245,255,.45);}
    .hint{
      font-size:12px;
      color: rgba(244,245,255,.55);
      line-height:1.4;
      margin-top:10px;
    }

    /* Alerts */
    #toast{
      position:fixed;
      bottom:22px;
      left:50%;
      transform:translateX(-50%);
      background: rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.15);
      color:#fff;
      padding:12px 16px;
      border-radius:999px;
      display:none;
      z-index:10001;
      max-width: 92vw;
      text-align:center;
      backdrop-filter: blur(12px);
    }

    /* Small list */
    .mini{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .mini-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      border-radius:18px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color:var(--muted);
      font-size:13px;
    }
    .mini-row b{color:var(--text); font-size:13px;}
    .ok{color:rgba(46,204,113,.95);}
    .err{color:rgba(255,93,93,.95);}

    /* Footer note */
    .footer-note{
      margin-top:18px;
      color:rgba(244,245,255,.55);
      font-size:12px;
      line-height:1.5;
      text-align:center;
    }
  </style>
</head>

<body>
  <div id="toast"></div>

  <header>
    <div class="topbar">
      <div class="brand" onclick="location.reload()">
        <div class="mark">Ï€</div>
        <div class="t">
          <b>Donate Way Wallet</b>
          <span>Ù…Ø­ÙØ¸Ø© Ø­ÙØ¸ Ï€ â€” Ø¥ÙŠØ¯Ø§Ø¹ ÙˆØ³Ø­Ø¨</span>
        </div>
      </div>

      <div class="actions">
        <div id="user-pill" class="pill"></div>
        <button id="login-button" class="btn primary" onclick="login()">ğŸ” Ø¯Ø®ÙˆÙ„ Pi</button>
        <button id="logout-button" class="btn danger" style="display:none" onclick="logout()">â‹ Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div class="hero">
      <!-- Wallet Card -->
      <div class="card">
        <div class="card-h">
          <div class="title">
            <b>ğŸ‘› Ø±ØµÙŠØ¯ Ù…Ø­ÙØ¸ØªÙƒ</b>
            <span>ÙŠØªÙ… Ø­Ø³Ø§Ø¨Ù‡ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: (Ø¥ÙŠØ¯Ø§Ø¹Ø§Øª - Ø³Ø­ÙˆØ¨Ø§Øª)</span>
          </div>
          <div class="badge" id="wallet-status">ØºÙŠØ± Ù…Ø³Ø¬Ù„</div>
        </div>
        <div class="card-b">
          <div class="balance">
            <div class="num" id="user-balance">0.00 Ï€</div>
            <div class="sub">
              <div class="kv">ğŸ†” <span id="uid-view">â€”</span></div>
              <div class="kv">ğŸ‘¤ <span id="username-view">â€”</span></div>
            </div>
          </div>

          <div class="hint">
            âœ… Ù„Ø§Ø²Ù… ØªÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¯Ø§Ø®Ù„ <b>Pi Browser</b> Ø¹Ù„Ø´Ø§Ù† Ø§Ù„Ø¯ÙØ¹ ÙŠØ´ØªØºÙ„.  
            Ù„Ùˆ Ø­Ø§Ø¨Ø¨ ØªØ®Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙ‚Ø¯Ø± â€œÙŠÙˆØ¯Ø¹ ÙƒØ¶ÙŠÙâ€ Ø¯ÙŠ Ù…Ø­ØªØ§Ø¬Ø© Ù…Ù†Ø·Ù‚ Ù…Ø®ØªÙ„Ù Ù„Ø£Ù† Pi SDK Ø£Ø³Ø§Ø³Ù‡ Ù…Ø³ØªØ®Ø¯Ù… Pi.
          </div>
        </div>
      </div>

      <!-- Quick Info Card -->
      <div class="card">
        <div class="card-h">
          <div class="title">
            <b>âš¡ Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</b>
            <span>Ù…ØªØ§Ø¨Ø¹Ø© Ø³Ø±ÙŠØ¹Ø©</span>
          </div>
          <div class="badge">Live</div>
        </div>
        <div class="card-b">
          <div class="mini">
            <div class="mini-row">
              <span>Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
              <b id="mini-auth" class="err">ØºÙŠØ± Ù…Ø³Ø¬Ù„</b>
            </div>
            <div class="mini-row">
              <span>Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©</span>
              <b id="mini-msg">â€”</b>
            </div>
            <div class="mini-row">
              <span>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</span>
              <b id="mini-bal">0.00 Ï€</b>
            </div>
          </div>

          <div class="footer-note">
            ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ approve/complete ÙÙŠ Ø§Ù„Ø¨Ø§Ùƒ Ø§Ù†Ø¯ Ø¨ØªØ§Ø¹Ùƒ.
          </div>
        </div>
      </div>
    </div>

    <div style="height:18px"></div>

    <div class="grid2">
      <!-- Deposit Card -->
      <div class="card">
        <div class="card-h">
          <div class="title">
            <b>ğŸ’³ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ (Ø¯ÙØ¹)</b>
            <span>Ø¥Ø¶Ø§ÙØ© Ï€ Ù„Ù…Ø­ÙØ¸ØªÙƒ</span>
          </div>
          <div class="badge">Deposit</div>
        </div>
        <div class="card-b">
          <div class="field">
            <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ï€)</label>
            <input id="deposit-amount" type="number" min="0" step="0.01" placeholder="Ù…Ø«Ø§Ù„: 1.50" />
          </div>

          <div style="height:12px"></div>

          <button id="btn-deposit" class="btn primary" style="width:100%; justify-content:center;" onclick="handleDeposit()">
            â• Ø¥ÙŠØ¯Ø§Ø¹ Ø§Ù„Ø¢Ù†
          </button>

          <div class="hint">
            ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ ÙÙŠ Ø¬Ø¯ÙˆÙ„ <b>donations</b> ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¯ÙØ¹ (Ù†ÙØ³ Ù…Ù†Ø·Ù‚Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚).
          </div>
        </div>
      </div>

      <!-- Withdraw Card -->
      <div class="card">
        <div class="card-h">
          <div class="title">
            <b>ğŸ§ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø³Ø­Ø¨</b>
            <span>Ø³Ø­Ø¨ â€œtest payâ€ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø§Ùƒ Ø§Ù†Ø¯</span>
          </div>
          <div class="badge">Withdraw</div>
        </div>
        <div class="card-b">
          <div class="field">
            <label>Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙØ¸ØªÙƒ (G...)</label>
            <input id="withdraw-address" type="text" placeholder="G..." />
          </div>

          <div style="height:12px"></div>

          <div class="field">
            <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ï€)</label>
            <input id="withdraw-amount" type="number" min="0" step="0.01" placeholder="Ù…Ø«Ø§Ù„: 0.50" />
          </div>

          <div style="height:12px"></div>

          <button id="btn-withdraw" class="btn danger" style="width:100%; justify-content:center;" onclick="executeWithdraw()">
            â¬‡ï¸ ØªØ£ÙƒÙŠØ¯ Ø³Ø­Ø¨ Ø§Ù„ØªØ³Øª Ø¨Ø§ÙŠ
          </button>

          <div class="hint" id="withdraw-status">â€”</div>
        </div>
      </div>
    </div>

    <div class="footer-note">
      Â© Donate Way Wallet â€” ÙˆØ§Ø¬Ù‡Ø© ÙÙ‚Ø·. Ù†ÙØ³ Supabase + Ù†ÙØ³ Ø¨Ø§Ùƒ Ø§Ù†Ø¯ Ø§Ù„Ø¯ÙØ¹ ÙˆØ§Ù„Ø³Ø­Ø¨ Ø¹Ù†Ø¯Ùƒ.
    </div>
  </div>

  <script>
    // ====== SUPABASE CONFIG (ÙƒÙ…Ø§ Ù‡Ùˆ) ======
    const SUPABASE_URL = 'https://xncapmzlwuisupkjlftb.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_zPECXAiI_bDbeLtRYe3vIw_IEt_p_AS';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const Pi = window.Pi;
    let currentUser = null;
    let userBalance = 0;

    // Toast
    function toast(msg){
      const t = document.getElementById('toast');
      t.innerText = msg;
      t.style.display = 'block';
      clearTimeout(window.__toastT);
      window.__toastT = setTimeout(()=> t.style.display='none', 2800);
      document.getElementById('mini-msg').innerText = msg;
    }

    // 1) Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© (Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ù…ØªØµÙØ­ Pi)
    const onIncompletePaymentFound = async (payment) => {
      console.log("Incomplete payment found", payment);
      // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¨Ø¹Ø¶ Ø§Ù„Ø­Ø§Ù„Ø§Øª payment.transaction Ù‚Ø¯ ØªÙƒÙˆÙ† null Ø­Ø³Ø¨ Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
      const txid = payment?.transaction?.txid;
      if(!txid){
        // Ù„Ùˆ Ù…ÙÙŠØ´ txidØŒ Ø³ÙŠØ¨Ù‡Ø§ Ù„Ù„Ù€ SDK ÙŠÙƒÙ…Ù„Ù‡Ø§
        return;
      }
      return fetch('/api/pi/complete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ paymentId: payment.identifier, txid })
      });
    };

    // 2) ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    async function login() {
      try {
        const auth = await Pi.authenticate(['username', 'payments'], onIncompletePaymentFound);
        currentUser = auth.user;

        document.getElementById('login-button').style.display = 'none';
        document.getElementById('logout-button').style.display = 'inline-flex';

        document.getElementById('user-pill').style.display = 'inline-flex';
        document.getElementById('user-pill').innerText = `@${currentUser.username}`;

        document.getElementById('wallet-status').innerText = 'Ù…ØªØµÙ„';
        document.getElementById('mini-auth').innerText = 'Ù…ØªØµÙ„';
        document.getElementById('mini-auth').className = 'ok';

        document.getElementById('uid-view').innerText = currentUser.uid;
        document.getElementById('username-view').innerText = '@' + currentUser.username;

        toast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ âœ…');
        await fetchUserBalance();
      } catch (e) {
        console.log(e);
        alert("Ø§ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¯Ø§Ø®Ù„ Ù…ØªØµÙØ­ Pi");
      }
    }

    function logout(){
      // Pi SDK Ù„Ø§ ÙŠÙˆÙØ± logout Ø±Ø³Ù…ÙŠ ÙˆØ§Ø¶Ø­ Ø¯Ø§ÙŠÙ…Ù‹Ø§ â€” ÙÙ‡Ù†Ø§ Ø¨Ù†Ø¹Ù…Ù„ reset UI ÙÙ‚Ø·
      currentUser = null;
      userBalance = 0;

      document.getElementById('login-button').style.display = 'inline-flex';
      document.getElementById('logout-button').style.display = 'none';
      document.getElementById('user-pill').style.display = 'none';

      document.getElementById('wallet-status').innerText = 'ØºÙŠØ± Ù…Ø³Ø¬Ù„';
      document.getElementById('mini-auth').innerText = 'ØºÙŠØ± Ù…Ø³Ø¬Ù„';
      document.getElementById('mini-auth').className = 'err';

      document.getElementById('uid-view').innerText = 'â€”';
      document.getElementById('username-view').innerText = 'â€”';

      updateBalanceUI();
      toast('ØªÙ… Ø§Ù„Ø®Ø±ÙˆØ¬');
    }

    // 3) Ø¬Ù„Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ù† Supabase
    async function fetchUserBalance() {
      if (!currentUser) return;

      const { data: dons, error: e1 } = await _supabase
        .from('donations')
        .select('amount')
        .eq('pi_user_id', currentUser.uid);

      const { data: wits, error: e2 } = await _supabase
        .from('withdrawals')
        .select('amount')
        .eq('pi_user_id', currentUser.uid);

      if(e1) console.log('donations error', e1);
      if(e2) console.log('withdrawals error', e2);

      const totalD = dons?.reduce((s, d) => s + parseFloat(d.amount), 0) || 0;
      const totalW = wits?.reduce((s, w) => s + parseFloat(w.amount), 0) || 0;

      userBalance = totalD - totalW;
      updateBalanceUI();
    }

    function updateBalanceUI(){
      document.getElementById('user-balance').innerText = userBalance.toFixed(2) + " Ï€";
      document.getElementById('mini-bal').innerText = userBalance.toFixed(2) + " Ï€";
    }

    // 4) Ø¥ÙŠØ¯Ø§Ø¹ (Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„ÙƒÙ† Ø¨Ø¯ÙˆÙ† Ø­Ù…Ù„Ø§Øª)
    function handleDeposit() {
      if (!currentUser) return alert("Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø£ÙˆÙ„Ø§Ù‹");

      const amount = parseFloat(document.getElementById('deposit-amount').value);
      if (!amount || amount <= 0) return alert("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");

      const btn = document.getElementById('btn-deposit');
      btn.disabled = true;
      btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...";

      Pi.createPayment({
        amount: amount,
        memo: `Ø¥ÙŠØ¯Ø§Ø¹ ÙÙŠ Ù…Ø­ÙØ¸Ø© Donate Way`,
        metadata: { type: "deposit" }
      }, {
        onReadyForServerApproval: (paymentId) => {
          return fetch('/api/pi/approve', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ paymentId })
          });
        },
        onReadyForServerCompletion: (paymentId, txid) => {
          return fetch('/api/pi/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ paymentId, txid })
          }).then(async () => {
            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ ÙÙŠ donations (ÙƒÙ…Ø§ ÙƒÙ†Øª Ø¨ØªØ¹Ù…Ù„)
            await _supabase.from('donations').insert([{
              pi_user_id: currentUser.uid,
              username: currentUser.username,
              amount: amount,
              campaign_id: null // Ø¹Ù„Ø´Ø§Ù† Ù…Ø§ Ù†Ø¹ØªÙ…Ø¯Ø´ Ø¹Ù„Ù‰ Ø­Ù…Ù„Ø§Øª
            }]);

            toast("ØªÙ… Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
            btn.disabled = false;
            btn.innerText = "â• Ø¥ÙŠØ¯Ø§Ø¹ Ø§Ù„Ø¢Ù†";
            document.getElementById('deposit-amount').value = '';

            await fetchUserBalance();
          });
        },
        onCancel: () => {
          toast("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©");
          btn.disabled = false;
          btn.innerText = "â• Ø¥ÙŠØ¯Ø§Ø¹ Ø§Ù„Ø¢Ù†";
        },
        onError: (error) => {
          console.log(error);
          alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯ÙØ¹");
          btn.disabled = false;
          btn.innerText = "â• Ø¥ÙŠØ¯Ø§Ø¹ Ø§Ù„Ø¢Ù†";
        }
      });
    }

    // 5) Ø³Ø­Ø¨ (App-to-User) â€” Ù†ÙØ³ endpoint Ø¨ØªØ§Ø¹Ùƒ
    async function executeWithdraw() {
      if(!currentUser) return alert("Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø£ÙˆÙ„Ø§Ù‹");

      const address = document.getElementById('withdraw-address').value.trim();
      const amount = parseFloat(document.getElementById('withdraw-amount').value);

      if(!address || !address.startsWith('G')) return alert("Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù† Ù…Ø­ÙØ¸Ø© ØµØ­ÙŠØ­ ÙŠØ¨Ø¯Ø£ Ø¨Ù€ G");
      if(!amount || amount <= 0) return alert("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");
      if (amount > userBalance) return alert("Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ");

      const btn = document.getElementById('btn-withdraw');
      btn.disabled = true;
      document.getElementById('withdraw-status').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ù„ÙˆÙƒØ´ÙŠÙ†...";

      try {
        const res = await fetch('/api/withdraw', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            uid: currentUser.uid,
            username: currentUser.username,
            amount,
            walletAddress: address
          })
        });

        const data = await res.json();

        if (res.ok) {
          toast("ØªÙ… Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
          document.getElementById('withdraw-status').innerText = "ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨Ù†Ø¬Ø§Ø­.";
          document.getElementById('withdraw-amount').value = '';
          // Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ù…ÙƒÙ† ØªØ³ÙŠØ¨Ù‡ Ø²ÙŠ Ù…Ø§ Ù‡Ùˆ
          await fetchUserBalance();
        } else {
          const msg = data?.error || data?.message || "ÙØ´Ù„ Ø§Ù„Ø³Ø­Ø¨";
          document.getElementById('withdraw-status').innerText = "Ø®Ø·Ø£: " + msg;
          alert("Ø®Ø·Ø£: " + msg);
        }
      } catch (e) {
        c
