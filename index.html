<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pi Vault - Ø§Ù„Ø±Ø¨Ø· Ø§Ù„ÙƒØ§Ù…Ù„</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700&display=swap" rel="stylesheet">
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --pi-p: #6d28d9; --pi-g: linear-gradient(135deg, #6d28d9 0%, #4c1d95 100%); --bg: #f3f4f6; --success: #10b981; --danger: #ef4444; }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; }
    body { background-color: var(--bg); color: #1f2937; padding-bottom: 40px; }
    header { background: white; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .hero { background: var(--pi-g); color: white; padding: 40px 20px; text-align: center; border-bottom-left-radius: 40px; border-bottom-right-radius: 40px; margin-bottom: 25px; }
    .bal-val { font-size: 3rem; font-weight: 800; margin: 10px 0; }
    .container { max-width: 450px; margin: 0 auto; padding: 0 15px; }
    .card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
    input { width: 100%; padding: 12px; border-radius: 12px; border: 1.5px solid #eee; margin-bottom: 10px; outline: none; text-align: center; font-size: 1rem; }
    .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .btn-dep { background: var(--pi-p); color: white; }
    .btn-wit { background: white; border: 2px solid #ddd; color: #555; }
    .hist-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f9f9f9; }
    .plus { color: var(--success); font-weight: bold; }
    .minus { color: var(--danger); font-weight: bold; }
    .small { font-size: .85rem; opacity: .8; margin-top: 6px; }
  </style>
</head>
<body>

<header>
  <div style="font-weight: 800; color: var(--pi-p);">Pi Vault</div>
  <div id="u-name" style="font-size: 0.8rem;"></div>
</header>

<div id="app" style="display: none;">
  <div class="hero">
    <div style="opacity: 0.8; font-size: 0.9rem;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ù…Ø­ÙÙˆØ¸</div>
    <div class="bal-val"><span style="color: #facc15;">Ï€</span> <span id="user-balance">0.00</span></div>
    <div id="pay-hint" class="small"></div>
  </div>

  <div class="container">
    <div class="card">
      <h4 style="margin-bottom: 15px;">ğŸ“¥ Ø¥ÙŠØ¯Ø§Ø¹ (Donation Table)</h4>
      <input type="number" id="d-amount" placeholder="0.00" step="0.01" min="0">
      <button class="btn btn-dep" id="btn-d" onclick="handleDeposit()">ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø±ØµÙŠØ¯</button>
    </div>

    <div class="card">
      <h4 style="margin-bottom: 15px;">ğŸ“¤ Ø³Ø­Ø¨ (Withdraw Table)</h4>
      <input type="text" id="w-addr" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø© G...">
      <input type="number" id="w-amount" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ï€" step="0.01" min="0">
      <button class="btn btn-wit" id="btn-w" onclick="handleWithdraw()">Ø³Ø­Ø¨ Ø§Ù„Ø¢Ù†</button>
    </div>

    <div class="card">
      <h4 style="margin-bottom: 15px;">ğŸ•’ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</h4>
      <div id="history-box"></div>
    </div>
  </div>
</div>

<div id="login-box" style="text-align: center; margin-top: 100px;">
  <button class="btn btn-dep" style="width: 200px;" onclick="initAuth()">Ø¯Ø®ÙˆÙ„ Pi Browser</button>
</div>

<script>
  const S_URL = 'https://xncapmzlwuisupkjlftb.supabase.co';
  const S_KEY = 'sb_publishable_zPECXAiI_bDbeLtRYe3vIw_IEt_p_AS';
  const _db = supabase.createClient(S_URL, S_KEY);

  const Pi = window.Pi;
  let user = null;

  // âœ… ID Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ© Ø¯ÙØ¹ (Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·)
  let lastPaymentId = null;

  async function initAuth() {
    try {
      const auth = await Pi.authenticate(['username', 'payments'], onIncomplete);
      user = auth.user;

      document.getElementById('login-box').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      document.getElementById('u-name').innerText = `@${user.username}`;

      updateUI();
    } catch (e) {
      alert("ÙŠØ¬Ø¨ Ø§Ù„ÙØªØ­ Ù…Ù† Pi Browser");
    }
  }

  // âœ… Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ø±ØµÙŠØ¯
  async function updateUI() {
    if (!user) return;

    const { data: dData } = await _db.from('donations').select('*').eq('pi_user_id', user.uid);
    const { data: wData } = await _db.from('withdrawals').select('*').eq('pi_user_id', user.uid);

    // âœ… Ø§Ù„Ù…Ù‡Ù…: Ù†Ø­Ø³Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ù† Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© ÙÙ‚Ø·
    const totalIn = (dData || [])
      .filter(x => (x.status || 'completed') === 'completed')
      .reduce((a, b) => a + parseFloat(b.amount), 0) || 0;

    const totalOut = (wData || []).reduce((a, b) => a + parseFloat(b.amount), 0) || 0;
    const balance = totalIn - totalOut;

    document.getElementById('user-balance').innerText = balance.toFixed(2);

    // Ø³Ø¬Ù„ Ø¢Ø®Ø± 5
    const combined = [
      ...(dData || []).map(x => ({...x, type: 'in'})),
      ...(wData || []).map(x => ({...x, type: 'out'}))
    ].sort((a,b) => new Date(b.created_at) - new Date(a.created_at)).slice(0,5);

    document.getElementById('history-box').innerHTML = combined.map(h => `
      <div class="hist-item">
        <span>
          ${h.type === 'in' ? 'Ø¥ÙŠØ¯Ø§Ø¹' : 'Ø³Ø­Ø¨'}
          ${h.type === 'in' && h.status ? `<span class="small">(${h.status})</span>` : ``}
        </span>
        <span class="${h.type === 'in' ? 'plus' : 'minus'}">
          ${h.type === 'in' ? '+' : '-'}${parseFloat(h.amount).toFixed(2)}
        </span>
      </div>
    `).join('');

    // Ø¹Ø±Ø¶ Ø¢Ø®Ø± paymentId
    document.getElementById('pay-hint').innerText =
      lastPaymentId ? `Ø¢Ø®Ø± Payment ID: ${lastPaymentId}` : '';
  }

  // âœ… helper: Ø¥Ø¯Ø±Ø§Ø¬ ØµÙ pending ÙÙŠ donations
  async function insertPendingDonation({ paymentId, amount, memo, metadata }) {
    // Ù„Ùˆ Ø§ØªÙƒØ±Ø± Ù†ÙØ³ paymentId Ù„Ø£ÙŠ Ø³Ø¨Ø¨ØŒ Ù†Ø®Ù„ÙŠÙ‡ upsert Ø¨Ø¯Ù„ Ù…Ø§ ÙŠØ±Ù…ÙŠ error
    const payload = {
      pi_user_id: user.uid,
      username: user.username,
      amount: amount,
      payment_id: paymentId,
      status: 'pending',
      memo: memo || null,
      metadata: metadata || null
    };

    const { error } = await _db
      .from('donations')
      .upsert([payload], { onConflict: 'payment_id' });

    if (error) throw error;
  }

  // âœ… helper: ØªØ­Ø¯ÙŠØ« ØµÙ Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§ÙƒØªÙ…Ø§Ù„
  async function markDonationCompleted({ paymentId, txid }) {
    const { error } = await _db
      .from('donations')
      .update({ status: 'completed', txid: txid })
      .eq('payment_id', paymentId);

    if (error) throw error;
  }

  // âœ… helper: ØªØ­Ø¯ÙŠØ« ØµÙ Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ù„ØºØ§Ø¡/Ø§Ù„Ø®Ø·Ø£
  async function markDonationFailed({ paymentId, reason }) {
    const { error } = await _db
      .from('donations')
      .update({ status: 'failed', metadata: { reason: reason || 'unknown' } })
      .eq('payment_id', paymentId);

    // Ù…Ø´ Ù‡Ù†Ø±Ù…ÙŠ error Ù‡Ù†Ø§ Ø¹Ø´Ø§Ù† Ù…Ø§ Ù†ÙƒØ³Ø±Ø´ Ø§Ù„Ù€ flow
    if (error) console.log('markDonationFailed error', error);
  }

  // âœ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ + Ø§Ù„Ø±Ø¨Ø· Ø¨Ø¬Ø¯ÙˆÙ„ donations
  async function handleDeposit() {
    const val = parseFloat(document.getElementById('d-amount').value);
    if (!val || val <= 0) return alert("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„ØºØ§Ù‹");

    const btn = document.getElementById('btn-d');
    btn.disabled = true;

    const memo = "ØªØ¹Ø¨Ø¦Ø© Ø±ØµÙŠØ¯ Vault";
    const metadata = { action: "deposit", app: "PiVault" };

    try {
      await Pi.createPayment({
        amount: val,
        memo,
        metadata
      }, {
        onReadyForServerApproval: async (paymentId) => {
          lastPaymentId = paymentId;
          updateUI();

          // âœ… 1) Ù†Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ² pending Ø¨Ù…Ø¬Ø±Ø¯ Ø¸Ù‡ÙˆØ± paymentId
          await insertPendingDonation({
            paymentId,
            amount: val,
            memo,
            metadata
          });

          // âœ… 2) Ù†Ø·Ù„Ø¨ approve Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
          const res = await fetch('/api/pi/approve', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ paymentId })
          });

          // Ù„Ùˆ Ø¹Ø§ÙŠØ² ØªØ´ÙŠÙƒ errors Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
          const j = await res.json().catch(() => ({}));
          if (!res.ok) {
            await markDonationFailed({ paymentId, reason: j?.error_message || 'approve_failed' });
            throw new Error('Approve failed');
          }

          return j;
        },

        onReadyForServerCompletion: async (paymentId, txid) => {
          lastPaymentId = paymentId;
          updateUI();

          // âœ… 3) Ù†Ø­Ø¯Ù‘Ø« ØµÙ donation Ù„Ù†ÙØ³ paymentId: completed + txid
          await markDonationCompleted({ paymentId, txid });

          // âœ… 4) Ù†Ø·Ù„Ø¨ complete Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
          const res = await fetch('/api/pi/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ paymentId, txid })
          });

          const j = await res.json().catch(() => ({}));
          if (!res.ok) {
            // Ù„Ùˆ complete ÙØ´Ù„ Ø¹Ù†Ø¯ÙƒØŒ Ø®Ù„ÙŠÙ‡ failed (Ø£Ùˆ Ø®Ù„ÙŠÙ‡ pending Ù„Ùˆ ØªÙØ¶Ù‘Ù„)
            await markDonationFailed({ paymentId, reason: j?.error_message || 'complete_failed' });
            throw new Error('Complete failed');
          }

          alert("ØªÙ… Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ø¨Ù†Ø¬Ø§Ø­!");
          document.getElementById('d-amount').value = "";
          await updateUI();
          btn.disabled = false;
        },

        onCancel: async () => {
          // Ù„Ùˆ ÙƒØ§Ù† Ø¹Ù†Ø¯Ù†Ø§ paymentId Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ù†Ø¹Ù„Ù…Ù‡ failed
          if (lastPaymentId) await markDonationFailed({ paymentId: lastPaymentId, reason: 'user_cancelled' });
          btn.disabled = false;
        },

        onError: async (err) => {
          if (lastPaymentId) await markDonationFailed({ paymentId: lastPaymentId, reason: err?.toString?.() || 'pi_error' });
          btn.disabled = false;
        }
      });

    } catch (e) {
      console.log(e);
      btn.disabled = false;
    }
  }

  // ØªÙ†ÙÙŠØ° Ø§Ù„Ø³Ø­Ø¨ (Ø²ÙŠ Ù…Ø§ Ù‡Ùˆ Ø¹Ù†Ø¯Ùƒ)
  async function handleWithdraw() {
    const addr = document.getElementById('w-addr').value;
    const amt = parseFloat(document.getElementById('w-amount').value);
    const currentBal = parseFloat(document.getElementById('user-balance').innerText);

    if (!addr || !amt || amt <= 0) return alert("Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø¨");
    if (amt > currentBal) return alert("Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ");

    const btn = document.getElementById('btn-w');
    btn.disabled = true;

    try {
      const { error } = await _db.from('withdrawals').insert([{
        pi_user_id: user.uid,
        username: user.username,
        amount: amt,
        wallet_address: addr
      }]);

      if (error) throw error;

      await fetch('/api/withdraw', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ uid: user.uid, amount: amt, walletAddress: addr })
      });

      alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨!");
      document.getElementById('w-amount').value = "";
      updateUI();
    } catch (e) {
      alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³Ø­Ø¨");
    }
    btn.disabled = false;
  }

  // âœ… Ù…Ù‡Ù…: Ù„Ùˆ ÙÙŠÙ‡ Ø¹Ù…Ù„ÙŠØ© incomplete Ù…Ù† Pi SDKØŒ Ù†Ø­Ø¯Ù‘Ø« Ù†ÙØ³ ØµÙ payment_id
  const onIncomplete = async (p) => {
    try {
      const paymentId = p.identifier;
      const txid = p?.transaction?.txid;

      if (!paymentId) return;

      lastPaymentId = paymentId;

      // Ù„Ùˆ txid Ù…ÙˆØ¬ÙˆØ¯ Ù†Ø¹ØªØ¨Ø±Ù‡Ø§ completed
      if (txid) {
        await markDonationCompleted({ paymentId, txid });
        await fetch('/api/pi/complete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ paymentId, txid })
        });
      } else {
        await markDonationFailed({ paymentId, reason: 'incomplete_no_txid' });
      }

      updateUI();
    } catch (e) {
      console.log('onIncomplete error', e);
    }
  };

  window.onload = () => Pi.init({ version: "2.0" });
</script>

</body>
</html>
