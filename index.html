<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Pi Vault - Ù…Ø­ÙØ¸Ø© Ø­ÙØ¸ Pi</title>

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700;800&display=swap" rel="stylesheet">
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --p:#7c3aed;
      --p2:#4c1d95;
      --bg:#0b0b14;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.09);
      --stroke:rgba(255,255,255,.12);
      --text:#f6f2ff;
      --muted:rgba(246,242,255,.72);
      --good:#10b981;
      --bad:#ef4444;
      --warn:#f59e0b;
      --shadow: 0 18px 60px rgba(0,0,0,.42);
      --r:22px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Arial;
      color:var(--text);
      background:
        radial-gradient(900px 520px at 12% 0%, rgba(124,58,237,.35), transparent 60%),
        radial-gradient(900px 520px at 100% 20%, rgba(76,29,149,.35), transparent 60%),
        radial-gradient(700px 520px at 50% 100%, rgba(245,158,11,.10), transparent 55%),
        var(--bg);
      padding-bottom: env(safe-area-inset-bottom);
      overflow-x:hidden;
    }

    .wrap{
      width:min(480px, 100%);
      margin:0 auto;
      padding: 16px 14px 28px;
    }

    /* Topbar */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 20;
      padding: 10px 10px 12px;
      backdrop-filter: blur(16px);
      background: linear-gradient(to bottom, rgba(11,11,20,.82), rgba(11,11,20,.30));
      border-bottom: 1px solid rgba(255,255,255,.06);
      margin: -16px -14px 14px;
    }
    .topbarInner{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 6px 10px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .logo{
      width:40px; height:40px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--p) 0%, var(--p2) 100%);
      box-shadow: 0 16px 45px rgba(124,58,237,.30);
      display:grid;
      place-items:center;
      border: 1px solid rgba(255,255,255,.18);
    }
    .logo span{ font-size:18px; }
    .brandText .t1{ font-size:14px; font-weight:900; }
    .brandText .t2{ font-size:12px; color:var(--muted); margin-top:2px; }

    .userPill{
      display:none;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color: var(--muted);
      font-size: 12.5px;
      max-width: 58%;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background: var(--good);
      box-shadow: 0 0 0 5px rgba(16,185,129,.12);
      flex:0 0 auto;
    }

    /* Panels */
    .panel{
      background: linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* Hero */
    .hero{
      padding: 18px 16px 16px;
      position:relative;
    }
    .hero:before{
      content:"";
      position:absolute;
      inset:-120px -120px auto auto;
      width:280px;height:280px;
      background: radial-gradient(circle, rgba(250,204,21,.22), transparent 60%);
      transform: rotate(18deg);
      pointer-events:none;
    }
    .heroTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      position:relative;
    }
    .heroTitle small{
      color: var(--muted);
      font-weight:500;
      font-size: 13px;
      display:block;
      margin-bottom:4px;
    }
    .heroTitle strong{
      font-size: 18px;
      font-weight:900;
      line-height:1.15;
    }
    .chip{
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(250,204,21,.12);
      border:1px solid rgba(250,204,21,.24);
      color: rgba(255,235,180,.95);
      font-size:12px;
      font-weight:800;
      flex:0 0 auto;
      text-align:center;
    }
    .balance{
      margin-top: 14px;
      display:flex;
      align-items:baseline;
      gap:10px;
      position:relative;
    }
    .pi{
      font-weight:900;
      font-size: 26px;
      color: rgba(250,204,21,.95);
    }
    .balNum{
      font-weight:900;
      font-size: 44px;
      letter-spacing:.5px;
      line-height:1;
    }
    .subRow{
      margin-top: 10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      color: var(--muted);
      font-size: 12.5px;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      direction:ltr;
      unicode-bidi:plaintext;
      max-width: 65%;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      text-align:left;
    }

    /* Cards */
    .grid{
      margin-top: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .cardHd{
      padding: 14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .cardHd h3{
      margin:0;
      font-size: 14px;
      font-weight:900;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .badge{
      font-size: 11px;
      color: var(--muted);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      padding: 6px 10px;
      background: rgba(255,255,255,.05);
      font-weight:800;
    }

    .cardBd{
      padding: 12px 14px 14px;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:7px;
      margin-bottom: 10px;
    }
    .label{
      color: var(--muted);
      font-size: 12px;
      font-weight:600;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .label .hint{ opacity:.9; font-size:11.5px; }

    input{
      width:100%;
      padding: 13px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline:none;
      font-size: 14.5px;
      text-align:center;
      transition:.18s;
    }
    input:focus{
      border-color: rgba(124,58,237,.55);
      box-shadow: 0 0 0 5px rgba(124,58,237,.18);
    }
    input::placeholder{ color: rgba(246,242,255,.42); }

    .btns{
      display:flex;
      gap:10px;
      margin-top: 6px;
    }
    button{
      border:none;
      cursor:pointer;
      font-weight:900;
      border-radius: 16px;
      padding: 13px 12px;
      font-size: 14px;
      transition: transform .08s, opacity .18s, box-shadow .18s;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    button:active{ transform: translateY(1px); }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .btnPrimary{
      background: linear-gradient(135deg, var(--p) 0%, var(--p2) 100%);
      color:white;
      box-shadow: 0 16px 45px rgba(124,58,237,.25);
      border: 1px solid rgba(255,255,255,.10);
      flex:1;
    }
    .btnGhost{
      background: rgba(255,255,255,.06);
      color: var(--text);
      border: 1px solid rgba(255,255,255,.12);
      flex:1;
    }
    .msg{
      margin-top:10px;
      font-size: 12.5px;
      color: var(--muted);
      line-height:1.55;
    }
    .msg b{ color: var(--text); }

    /* History */
    .hist{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .histItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.08);
    }
    .histLeft{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width: 0;
    }
    .histLeft .t{
      font-weight:900;
      font-size: 13.5px;
      display:flex;
      align-items:center;
      gap:7px;
    }
    .status{
      font-size: 11.5px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      color: var(--muted);
      background: rgba(255,255,255,.05);
      font-weight:800;
    }
    .status.ok{ border-color: rgba(16,185,129,.22); background: rgba(16,185,129,.10); color: rgba(210,255,235,.9); }
    .status.pend{ border-color: rgba(245,158,11,.25); background: rgba(245,158,11,.10); color: rgba(255,241,210,.92); }
    .status.fail{ border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.10); color: rgba(255,220,220,.92); }

    .histLeft .d{
      color: var(--muted);
      font-size: 12px;
      max-width: 240px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .amt{
      font-weight:900;
      font-size: 14px;
      direction:ltr;
      unicode-bidi:plaintext;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      text-align:left;
      flex:0 0 auto;
    }
    .amt.plus{ color: rgba(16,185,129,.95); }
    .amt.minus{ color: rgba(239,68,68,.95); }

    /* Login */
    .login{
      min-height: calc(100vh - 60px);
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:12px;
      text-align:center;
      padding: 20px 6px;
    }
    .login h1{
      margin:0;
      font-weight: 900;
      font-size: 26px;
      letter-spacing: .3px;
    }
    .login p{
      margin:0;
      color: var(--muted);
      font-size: 13.5px;
      line-height:1.7;
    }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      width: min(480px, calc(100% - 24px));
      background: rgba(10,10,18,.65);
      border: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(12px);
      border-radius: 16px;
      padding: 12px 14px;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      display:none;
      z-index: 50;
    }
    .toast.show{ display:block; animation: pop .18s ease-out; }
    @keyframes pop{ from{ transform:translateX(-50%) translateY(10px); opacity:.0; } to{ transform:translateX(-50%) translateY(0); opacity:1; } }
    .toast .t1{ font-weight:900; font-size: 13.5px; }
    .toast .t2{ margin-top: 4px; color: var(--muted); font-size: 12.5px; line-height:1.5; }

    @media (max-width: 360px){
      .balNum{ font-size: 40px; }
      .logo{ width:38px;height:38px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="topbarInner">
        <div class="brand">
          <div class="logo"><span>Ï€</span></div>
          <div class="brandText">
            <div class="t1">Pi Vault</div>
            <div class="t2">Ù…Ø­ÙØ¸Ø© Ø­ÙØ¸ Pi + Ø³Ø¬Ù„</div>
          </div>
        </div>

        <div class="userPill" id="userPill">
          <span class="dot"></span>
          <span id="u-name">@user</span>
        </div>
      </div>
    </div>

    <!-- LOGIN -->
    <div id="login-box" class="panel login">
      <h1>Ø§ÙØªØ­ Ù…Ù† Pi Browser</h1>
      <p>Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø¨Ø­Ø³Ø§Ø¨ Pi Ø¹Ù„Ø´Ø§Ù† ØªÙ‚Ø¯Ø± ØªØ¹Ù…Ù„ Ø¥ÙŠØ¯Ø§Ø¹ ÙˆØ³Ø­Ø¨ ÙˆØªØªØ§Ø¨Ø¹ Ø§Ù„Ø±ØµÙŠØ¯.</p>
      <div style="margin-top:12px;">
        <button class="btnPrimary" style="width:100%; border-radius:18px; padding:14px 14px;" onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      </div>
      <p style="font-size:12px; opacity:.95;">Ù„Ùˆ Ø§Ù„Ø²Ø± Ù…Ø´ Ø´ØºØ§Ù„: Ø§ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ <b>Pi Browser</b>.</p>
    </div>

    <!-- APP -->
    <div id="app" style="display:none;">
      <!-- HERO -->
      <div class="panel hero">
        <div class="heroTop">
          <div class="heroTitle">
            <small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ù…Ø­ÙÙˆØ¸</small>
            <strong>Ø±ØµÙŠØ¯ Ø§Ù„Ù€ Vault</strong>
          </div>
          <div class="chip">Pi Network</div>
        </div>

        <div class="balance">
          <div class="pi">Ï€</div>
          <div class="balNum" id="user-balance">0.00</div>
        </div>

        <div class="subRow">
          <div>Ø¢Ø®Ø± Payment ID</div>
          <div class="mono" id="last-payment">â€”</div>
        </div>
      </div>

      <div class="grid">
        <!-- Deposit -->
        <div class="panel">
          <div class="cardHd">
            <h3>ğŸ“¥ Ø¥ÙŠØ¯Ø§Ø¹</h3>
            <div class="badge">approve/complete</div>
          </div>
          <div class="cardBd">
            <div class="field">
              <div class="label">
                <span>Ø§Ù„Ù…Ø¨Ù„Øº</span>
                <span class="hint">Ï€</span>
              </div>
              <input type="number" id="dep-amount" inputmode="decimal" step="0.01" min="0" placeholder="0.00">
            </div>

            <div class="btns">
              <button class="btnPrimary" id="btn-dep" onclick="deposit()">Ø¥ÙŠØ¯Ø§Ø¹ Ø§Ù„Ø¢Ù†</button>
              <button class="btnGhost" onclick="quickFill(1)">+1</button>
            </div>

            <div class="msg">
              Ù†ÙØ³ ÙÙ„Ùˆ Ø§Ù„ÙƒÙˆØ¯ Ø¨ØªØ§Ø¹Ùƒ: <b>approve</b> Ø«Ù… <b>complete</b> ÙˆØ¨Ø¹Ø¯Ù‡Ø§ Ø¨Ù†Ø³Ø¬Ù„ ÙÙŠ Supabase.
            </div>
          </div>
        </div>

        <!-- Withdraw -->
        <div class="panel">
          <div class="cardHd">
            <h3>ğŸ“¤ Ø³Ø­Ø¨</h3>
            <div class="badge">/api/withdraw</div>
          </div>
          <div class="cardBd">
            <div class="field">
              <div class="label">
                <span>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©</span>
                <span class="hint">G...</span>
              </div>
              <input type="text" id="with-address" placeholder="G..." autocapitalize="off" autocomplete="off" spellcheck="false">
            </div>

            <div class="field" style="margin-bottom:0;">
              <div class="label">
                <span>Ø§Ù„ÙƒÙ…ÙŠØ©</span>
                <span class="hint">Ï€</span>
              </div>
              <input type="number" id="with-amount" inputmode="decimal" step="0.01" min="0" placeholder="0.00">
            </div>

            <div class="btns" style="margin-top:10px;">
              <button class="btnGhost" onclick="fillMax()">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰</button>
              <button class="btnPrimary" id="btn-with" onclick="withdraw()">Ø³Ø­Ø¨ Ø§Ù„Ø¢Ù†</button>
            </div>

            <div class="msg">
              Ø§Ù„Ø³Ø­Ø¨ Ø¨ÙŠØªÙ†ÙØ° Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± (Ø§Ù„Ù€ Seed Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø§Ùƒ Ø§Ù†Ø¯). Ù„Ùˆ endpoint Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ Ù‡ÙŠØ·Ù„Ø¹ Ø®Ø·Ø£.
            </div>
          </div>
        </div>

        <!-- History -->
        <div class="panel">
          <div class="cardHd">
            <h3>ğŸ•’ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</h3>
            <div class="badge" id="hist-badge">Ø¢Ø®Ø± 6</div>
          </div>
          <div class="cardBd">
            <div id="history-box" class="hist"></div>
            <div id="no-hist" class="msg" style="display:none;">Ù„Ø³Ù‡ Ù…ÙÙŠØ´ Ø­Ø±ÙƒØ§Øª.</div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <div class="t1" id="toastT1">â€”</div>
    <div class="t2" id="toastT2">â€”</div>
  </div>

<script>
  // =========================
  // Supabase
  // =========================
  const SUPABASE_URL = 'https://xncapmzlwuisupkjlftb.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_zPECXAiI_bDbeLtRYe3vIw_IEt_p_AS';
  const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // =========================
  // Pi SDK - Safe Init
  // =========================
  function getPi() {
    return window.Pi || window.pi || null;
  }

  function isPiBrowser() {
    // Pi Browser Ø¹Ø§Ø¯Ø© Ø¨ÙŠØ¶ÙŠÙ ÙƒØ¯Ù‡ØŒ Ø¨Ø³ Ù…Ø´ Ø¯Ø§ÙŠÙ…Ù‹Ø§ØŒ ÙØ¨Ù†Ø³ØªØ®Ø¯Ù… Ø£ÙƒØªØ± Ù…Ù† check
    const ua = navigator.userAgent || "";
    return /PiBrowser/i.test(ua) || !!getPi();
  }

  async function ensurePiReady() {
    const Pi = getPi();

    if (!Pi) {
      throw new Error("PI_SDK_NOT_FOUND");
    }

    // Ù„Ùˆ init Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ØŒ Ù†ÙƒÙ…Ù„ (Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ¦Ø§Øª)
    if (typeof Pi.init === "function") {
      try {
        // Ù…Ù‡Ù…: init Ù‚Ø¨Ù„ authenticate
        Pi.init({ version: "2.0" });
      } catch (e) {
        // Ù„Ùˆ Ø§ØªØ¹Ù…Ù„ init Ù‚Ø¨Ù„ ÙƒØ¯Ù‡ØŒ Ø¨Ø¹Ø¶ Ø§Ù„Ù†Ø³Ø® Ø¨ØªØ±Ù…ÙŠ error Ø¨Ø³ÙŠØ· - Ù†ØªØ¬Ø§Ù‡Ù„Ù‡
      }
    }

    // ØªØ£ÙƒØ¯ Ø¥Ù† authenticate Ù…ÙˆØ¬ÙˆØ¯
    if (typeof Pi.authenticate !== "function") {
      throw new Error("PI_AUTH_NOT_AVAILABLE");
    }

    return Pi;
  }

  // =========================
  // App State
  // =========================
  let currentUser = null;
  let userBalance = 0;
  let lastPaymentId = null;

  const $ = (id) => document.getElementById(id);

  function toast(title, msg){
    const t = $("toast");
    if(!t){ alert(title + "\n" + msg); return; }
    $("toastT1").innerText = title || "";
    $("toastT2").innerText = msg || "";
    t.classList.add("show");
    clearTimeout(window.__t);
    window.__t = setTimeout(()=> t.classList.remove("show"), 3200);
  }

  function shortId(s){
    if(!s) return "â€”";
    if(s.length <= 18) return s;
    return s.slice(0,8) + "â€¦" + s.slice(-8);
  }

  // =========================
  // Incomplete Payments
  // =========================
  const onIncompletePaymentFound = async (payment) => {
    try {
      if (!payment?.identifier || !payment?.transaction?.txid) return;

      await fetch('/api/pi/complete', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ paymentId: payment.identifier, txid: payment.transaction.txid })
      });

      // Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ø£Ø¹Ù…Ø¯Ø© status/txid/payment_id Ù‡ÙŠØªØ­Ø¯Ù‘Ø«ØŒ Ù„Ùˆ Ù„Ø£ Ù…Ø´ Ù‡ÙŠØ¨ÙˆÙ‘Ø¸
      _supabase.from('donations')
        .update({ status:'completed', txid: payment.transaction.txid })
        .eq('payment_id', payment.identifier);

    } catch (e) {
      console.log("onIncomplete error", e);
    }
  };

  // =========================
  // âœ… Login (Fixed)
  // =========================
  async function login(){
    try{
      if (!isPiBrowser()) {
        alert("Ø§ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¯Ø§Ø®Ù„ Pi Browser Ø¹Ù„Ø´Ø§Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙŠØ´ØªØºÙ„.");
        return;
      }

      // Ensure Pi is ready
      const Pi = await ensurePiReady();

      // Ø¨Ø¹Ø¶ Ø§Ù„Ù†Ø³Ø® Ø¨ØªØ­Ø¨ await Ù‡Ù†Ø§
      const auth = await Pi.authenticate(
        ['username','payments'],
        onIncompletePaymentFound
      );

      if (!auth || !auth.user) {
        throw new Error("AUTH_EMPTY");
      }

      currentUser = auth.user;

      // UI
      $("login-box").style.display = "none";
      $("app").style.display = "block";
      const pill = $("userPill");
      if (pill) pill.style.display = "flex";
      $("u-name").innerText = `@${currentUser.username}`;

      toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", `Ø£Ù‡Ù„Ù‹Ø§ ${currentUser.username}`);
      await fetchUserBalance();
      await loadHistory();

    }catch(e){
      console.log("login error:", e);

      if (String(e?.message) === "PI_SDK_NOT_FOUND") {
        alert("Pi SDK Ù…Ø´ Ù…ØªØ§Ø­. Ø§ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ù…Ù† Pi Browser Ø£Ùˆ ØªØ£ÙƒØ¯ Ø¥Ù† sdk.minepi.com Ø´ØºØ§Ù„.");
      } else if (String(e?.message) === "PI_AUTH_NOT_AVAILABLE") {
        alert("Pi.authenticate Ù…Ø´ Ù…ØªØ§Ø­. Ø¬Ø±Ù‘Ø¨ ØªØ­Ø¯Ø« Pi Browser Ø£Ùˆ Ø§ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ù…Ù† Ø¯Ø§Ø®Ù„ Pi Browser.");
      } else {
        alert("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. Ø§ÙØªØ­ Ù…Ù† Pi Browser ÙˆØ¬Ø±Ø¨ ØªØ§Ù†ÙŠ.");
      }
    }
  }

  // =========================
  // Balance + History (Ø²ÙŠ Ù…Ø§ ÙƒØ§Ù†ÙˆØ§)
  // =========================
  async function fetchUserBalance(){
    if(!currentUser) return;

    const { data: dons } = await _supabase.from('donations').select('amount,status').eq('pi_user_id', currentUser.uid);
    const { data: wits } = await _supabase.from('withdrawals').select('amount,status').eq('pi_user_id', currentUser.uid);

    const totalD = (dons || [])
      .filter(x => !x.status || x.status === 'completed')
      .reduce((s,d)=> s + parseFloat(d.amount), 0) || 0;

    const totalW = (wits || [])
      .filter(x => !x.status || x.status === 'completed')
      .reduce((s,w)=> s + parseFloat(w.amount), 0) || 0;

    userBalance 
