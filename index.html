<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi Chat Ultra</title>
    
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --primary: #6a1b9a;
            --secondary: #4a148c;
            --bg: #efe7dd;
            --white: #ffffff;
            --sent: #dcf8c6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; }

        body { background: #f0f2f5; height: 100vh; display: flex; overflow: hidden; }

        /* شاشة الدخول */
        #login-overlay {
            position: fixed; inset: 0; background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: white;
        }

        /* التصميم العام */
        .app-container { display: flex; width: 100%; height: 100vh; }

        /* القائمة الجانبية */
        .sidebar { width: 350px; background: white; border-left: 1px solid #ddd; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; background: var(--primary); color: white; }
        .user-list { flex: 1; overflow-y: auto; }
        .user-card { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .user-card:hover { background: #f5f5f5; }

        /* منطقة الدردشة */
        .chat-main { flex: 1; display: flex; flex-direction: column; background: var(--bg); }
        .chat-header { padding: 10px 20px; background: #f0f0f0; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #ddd; }
        
        /* قسم الدفع في الهيدر */
        .pay-section { margin-right: auto; display: flex; align-items: center; gap: 5px; background: #fff; padding: 5px 10px; border-radius: 20px; border: 1px solid #ffca28; }
        .pay-section input { width: 60px; border: none; outline: none; text-align: center; font-weight: bold; }
        .pay-btn { background: #ffca28; border: none; padding: 5px 15px; border-radius: 15px; cursor: pointer; font-weight: bold; }

        .messages-area { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 75%; padding: 10px 15px; border-radius: 15px; font-size: 15px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg.sent { align-self: flex-end; background: var(--sent); border-top-left-radius: 2px; }
        .msg.received { align-self: flex-start; background: white; border-top-right-radius: 2px; }

        .input-bar { padding: 15px; background: #f0f0f0; display: flex; gap: 10px; align-items: center; }
        .input-bar input { flex: 1; padding: 12px; border-radius: 25px; border: none; outline: none; }
        .send-btn { background: var(--primary); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; }

        @media (max-width: 768px) { .sidebar { display: none; } }
    </style>
</head>
<body>

    <div id="login-overlay">
        <i class="fab fa-pi" style="font-size: 50px; margin-bottom: 15px;"></i>
        <h2>مرحباً بك في Pi Chat</h2>
        <button onclick="handlePiAuth()" style="margin-top:20px; padding:15px 30px; border-radius:25px; border:none; background:#ffca28; cursor:pointer; font-weight:bold;">دخول عبر Pi Network</button>
    </div>

    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header"><h3>المحادثات</h3></div>
            <div class="user-list" id="users"></div>
        </aside>

        <main class="chat-main">
            <div class="chat-header">
                <div id="activeUserName" style="font-weight: bold;">اختر صديقاً</div>
                <div class="pay-section" id="payPanel" style="display:none;">
                    <input type="number" id="piAmount" value="1" step="0.1" min="0.01">
                    <span style="font-size: 12px;">Pi</span>
                    <button class="pay-btn" onclick="payPi()">إرسال</button>
                </div>
            </div>

            <div class="messages-area" id="msgBox"></div>

            <div class="input-bar">
                <input type="text" id="msgInput" placeholder="اكتب رسالتك هنا..." onkeypress="if(event.key==='Enter') sendMsg()">
                <button class="send-btn" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </main>
    </div>

    <script>
        const SUPABASE_URL = "https://xncapmzlwuisupkjlftb.supabase.co";
        const SUPABASE_KEY = "sb_publishable_zPECXAiI_bDbeLtRYe3vIw_IEt_p_AS";
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const Pi = window.Pi;
        Pi.init({ version: "2.0", sandbox: false });

        let currentUser = null;
        let selectedUser = null;

        // 1. الدخول والمصادقة
        async function handlePiAuth() {
            try {
                const auth = await Pi.authenticate(['username', 'payments'], onIncompletePayment);
                currentUser = auth.user;

                await supabase.from('users').upsert({
                    username: currentUser.username,
                    pi_id: currentUser.uid,
                    last_seen: new Date()
                });

                document.getElementById('login-overlay').style.display = 'none';
                loadUsersList();
                listenToMessages(); // تشغيل الاستماع اللحظي
            } catch (e) { alert("فشل الدخول: " + e.message); }
        }

        function onIncompletePayment(payment) { /* منطق استعادة المدفوعات */ }

        // 2. جلب المستخدمين
        async function loadUsersList() {
            const { data } = await supabase.from('users').select('*');
            const list = document.getElementById('users');
            list.innerHTML = data.map(u => u.username !== currentUser.username ? `
                <div class="user-card" onclick="selectChat('${u.username}')">
                    <div style="width:40px;height:40px;background:#ccc;border-radius:50%"></div>
                    <span>${u.username}</span>
                </div>
            ` : '').join('');
        }

        // 3. اختيار الدردشة
        async function selectChat(username) {
            selectedUser = username;
            document.getElementById('activeUserName').innerText = username;
            document.getElementById('payPanel').style.display = 'flex';
            document.getElementById('msgBox').innerHTML = '';
            
            // جلب الأرشيف
            const { data } = await supabase.from('messages')
                .select('*')
                .or(`and(sender.eq.${currentUser.username},receiver.eq.${username}),and(sender.eq.${username},receiver.eq.${currentUser.username})`)
                .order('created_at', { ascending: true });

            if(data) data.forEach(appendMsg);
        }

        // 4. إرسال رسالة
        async function sendMsg() {
            const input = document.getElementById('msgInput');
            const val = input.value.trim();
            if(!val || !selectedUser) return;

            const newMsg = { sender: currentUser.username, receiver: selectedUser, content: val };
            
            // إظهار الرسالة فوراً في واجهة المرسل (Optimistic UI)
            appendMsg(newMsg); 
            input.value = '';

            await supabase.from('messages').insert([newMsg]);
        }

        // 5. الاستماع اللحظي (Realtime)
        function listenToMessages() {
            supabase.channel('chat_channel')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
                const msg = payload.new;
                // إظهار الرسالة فقط إذا كانت تخص المحادثة المفتوحة حالياً ولست أنا المرسل (لأنني أضفتها مسبقاً)
                if (msg.receiver === currentUser.username && msg.sender === selectedUser) {
                    appendMsg(msg);
                }
            })
            .subscribe();
        }

        function appendMsg(msg) {
            const box = document.getElementById('msgBox');
            const isMe = msg.sender === currentUser.username;
            const div = document.createElement('div');
            div.className = `msg ${isMe ? 'sent' : 'received'}`;
            div.innerText = msg.content;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // 6. نظام الدفع المطور
        async function payPi() {
            const amount = document.getElementById('piAmount').value;
            if(!selectedUser) return;

            try {
                const payment = await Pi.createPayment({
                    amount: parseFloat(amount),
                    memo: `تحويل إلى ${selectedUser}`,
                    metadata: { recipient: selectedUser }
                }, {
                    onReadyForServerApproval: (id) => {
                        console.log("الطلب ينتظر موافقة السيرفر:", id);
                        // أرسل الـ id إلى netlify function الخاصة بك هنا
                    },
                    onReadyForServerCompletion: (id, txid) => {
                        console.log("تم الدفع بنجاح!", txid);
                        alert(`تم إرسال ${amount} Pi بنجاح!`);
                    },
                    onCancel: (id) => console.log("تم إلغاء الدفع"),
                    onError: (err) => alert("خطأ في الدفع: " + err.message)
                });
            } catch (e) { alert("حدث خطأ: " + e.message); }
        }
    </script>
</body>
</html>
