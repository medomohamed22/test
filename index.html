<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Pi Vault</title>

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700;800&display=swap" rel="stylesheet">
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --p:#6d28d9;
      --p2:#4c1d95;
      --bg:#0b0b14;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.09);
      --stroke:rgba(255,255,255,.12);
      --text:#f4f4ff;
      --muted:rgba(244,244,255,.72);
      --good:#10b981;
      --bad:#ef4444;
      --warn:#f59e0b;

      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --r1:22px;
      --r2:18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Arial;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 10% 0%, rgba(109,40,217,.35), transparent 60%),
        radial-gradient(900px 500px at 100% 20%, rgba(76,29,149,.35), transparent 60%),
        radial-gradient(700px 500px at 50% 100%, rgba(245,158,11,.12), transparent 55%),
        var(--bg);
      padding-bottom: env(safe-area-inset-bottom);
    }

    .appShell{
      min-height:100%;
      display:flex;
      justify-content:center;
    }

    .wrap{
      width:min(480px, 100%);
      padding: 18px 14px 28px;
    }

    /* Top bar */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 20;
      padding: 10px 10px 12px;
      backdrop-filter: blur(14px);
      background: linear-gradient(to bottom, rgba(11,11,20,.78), rgba(11,11,20,.32));
      border-bottom: 1px solid rgba(255,255,255,.06);
      margin: -18px -14px 14px;
    }

    .topbarInner{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 6px 10px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:.2px;
    }

    .logo{
      width:38px; height:38px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--p) 0%, var(--p2) 100%);
      box-shadow: 0 16px 40px rgba(109,40,217,.35);
      display:grid;
      place-items:center;
      border: 1px solid rgba(255,255,255,.18);
    }
    .logo span{ font-size:18px; }

    .userPill{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color: var(--muted);
      font-size: 12.5px;
      max-width: 58%;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background: var(--good);
      box-shadow: 0 0 0 5px rgba(16,185,129,.12);
      flex:0 0 auto;
    }

    /* Hero */
    .hero{
      border-radius: var(--r1);
      background:
        radial-gradient(800px 240px at 30% 0%, rgba(109,40,217,.55), transparent 60%),
        radial-gradient(800px 240px at 100% 0%, rgba(76,29,149,.55), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      padding: 18px 16px 16px;
      overflow:hidden;
      position:relative;
    }
    .hero:before{
      content:"";
      position:absolute;
      inset:-120px -120px auto auto;
      width:280px;height:280px;
      background: radial-gradient(circle, rgba(250,204,21,.24), transparent 60%);
      filter: blur(2px);
      transform: rotate(18deg);
      pointer-events:none;
    }
    .heroTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      position:relative;
    }
    .heroTitle{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .heroTitle small{
      color: var(--muted);
      font-weight:500;
      font-size: 13px;
    }
    .heroTitle strong{
      font-size: 18px;
      font-weight:800;
      line-height:1.15;
    }

    .chip{
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(250,204,21,.12);
      border:1px solid rgba(250,204,21,.24);
      color: rgba(255,235,180,.95);
      font-size:12px;
      font-weight:700;
      flex:0 0 auto;
      text-align:center;
    }

    .balance{
      margin-top: 14px;
      display:flex;
      align-items:baseline;
      gap:10px;
      position:relative;
    }
    .pi{
      font-weight:900;
      font-size: 26px;
      color: rgba(250,204,21,.95);
    }
    .balNum{
      font-weight:900;
      font-size: 44px;
      letter-spacing:.5px;
      line-height:1;
    }
    .subRow{
      margin-top: 10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      color: var(--muted);
      font-size: 12.5px;
    }
    .subRow .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      direction:ltr;
      unicode-bidi:plaintext;
      max-width: 65%;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      text-align:left;
    }

    /* Layout cards */
    .grid{
      margin-top: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .card{
      background: linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--r1);
      box-shadow: 0 10px 40px rgba(0,0,0,.25);
      overflow:hidden;
    }

    .cardHd{
      padding: 14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .cardHd h3{
      margin:0;
      font-size: 14px;
      font-weight:800;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .badge{
      font-size: 11px;
      color: var(--muted);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      padding: 6px 10px;
      background: rgba(255,255,255,.05);
    }

    .cardBd{
      padding: 12px 14px 14px;
    }

    .row{
      display:flex;
      gap:10px;
    }
    .row > *{ flex:1; }

    .field{
      display:flex;
      flex-direction:column;
      gap:7px;
      margin-bottom: 10px;
    }
    .label{
      color: var(--muted);
      font-size: 12px;
      font-weight:500;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .label .hint{ opacity:.9; font-size:11.5px; }

    input{
      width:100%;
      padding: 13px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline:none;
      font-size: 14.5px;
      text-align:center;
      transition:.18s;
    }
    input:focus{
      border-color: rgba(109,40,217,.55);
      box-shadow: 0 0 0 5px rgba(109,40,217,.18);
    }
    input::placeholder{ color: rgba(244,244,255,.42); }

    .btns{
      display:flex;
      gap:10px;
      margin-top: 6px;
    }

    button{
      border:none;
      cursor:pointer;
      font-weight:900;
      border-radius: 16px;
      padding: 13px 12px;
      font-size: 14px;
      transition: transform .08s, opacity .18s, box-shadow .18s;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    button:active{ transform: translateY(1px); }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    .btnPrimary{
      background: linear-gradient(135deg, var(--p) 0%, var(--p2) 100%);
      color:white;
      box-shadow: 0 16px 45px rgba(109,40,217,.28);
      border: 1px solid rgba(255,255,255,.10);
      flex:1;
    }
    .btnGhost{
      background: rgba(255,255,255,.06);
      color: var(--text);
      border: 1px solid rgba(255,255,255,.12);
      flex:1;
    }

    .msg{
      margin-top:10px;
      font-size: 12.5px;
      color: var(--muted);
      line-height:1.5;
    }
    .msg b{ color: var(--text); }

    /* History */
    .hist{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .histItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.08);
    }
    .histLeft{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width: 0;
    }
    .histLeft .t{
      font-weight:800;
      font-size: 13.5px;
      display:flex;
      align-items:center;
      gap:7px;
    }
    .status{
      font-size: 11.5px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      color: var(--muted);
      background: rgba(255,255,255,.05);
      font-weight:700;
    }
    .status.ok{ border-color: rgba(16,185,129,.22); background: rgba(16,185,129,.10); color: rgba(210,255,235,.9); }
    .status.pend{ border-color: rgba(245,158,11,.25); background: rgba(245,158,11,.10); color: rgba(255,241,210,.92); }
    .status.fail{ border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.10); color: rgba(255,220,220,.92); }
    .histLeft .d{
      color: var(--muted);
      font-size: 12px;
      max-width: 240px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .amt{
      font-weight:900;
      font-size: 14px;
      direction:ltr;
      unicode-bidi:plaintext;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      text-align:left;
      flex:0 0 auto;
    }
    .amt.plus{ color: rgba(16,185,129,.95); }
    .amt.minus{ color: rgba(239,68,68,.95); }

    /* Login */
    .login{
      min-height: calc(100vh - 40px);
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:12px;
      text-align:center;
      padding: 20px 6px;
    }
    .login h1{
      margin:0;
      font-weight: 900;
      font-size: 26px;
      letter-spacing: .3px;
    }
    .login p{
      margin:0;
      color: var(--muted);
      font-size: 13.5px;
      line-height:1.6;
    }
    .login .bigBtn{
      width: 100%;
      padding: 14px 14px;
      border-radius: 18px;
      margin-top: 10px;
    }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      width: min(480px, calc(100% - 24px));
      background: rgba(10,10,18,.65);
      border: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(12px);
      border-radius: 16px;
      padding: 12px 14px;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      display:none;
      z-index: 50;
    }
    .toast.show{ display:block; animation: pop .18s ease-out; }
    @keyframes pop{ from{ transform:translateX(-50%) translateY(10px); opacity:.0; } to{ transform:translateX(-50%) translateY(0); opacity:1; } }
    .toast .t1{ font-weight:900; font-size: 13.5px; }
    .toast .t2{ margin-top: 4px; color: var(--muted); font-size: 12.5px; line-height:1.5; }

    /* Small devices tweaks */
    @media (max-width: 360px){
      .balNum{ font-size: 40px; }
      .logo{ width:36px;height:36px; border-radius: 13px; }
    }
  </style>
</head>
<body>
  <div class="appShell">
    <div class="wrap">

      <div class="topbar">
        <div class="topbarInner">
          <div class="brand">
            <div class="logo"><span>Ï€</span></div>
            <div>
              <div style="font-size:14px; font-weight:900;">Pi Vault</div>
              <div style="font-size:12px; color:var(--muted); margin-top:2px;">Wallet Vault + History</div>
            </div>
          </div>
          <div class="userPill" id="userPill" style="display:none;">
            <span class="dot"></span>
            <span id="u-name">@user</span>
          </div>
        </div>
      </div>

      <!-- LOGIN -->
      <div id="login-box" class="login">
        <h1>Ø§Ø¯Ø®Ù„ Ù…Ù† Pi Browser</h1>
        <p>
          Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø¨Ø­Ø³Ø§Ø¨ Pi Ø¹Ø´Ø§Ù† ØªÙ‚Ø¯Ø± ØªØ¹Ù…Ù„ <b>Ø¥ÙŠØ¯Ø§Ø¹</b> Ùˆ <b>Ø³Ø­Ø¨</b> ÙˆØªØªØ§Ø¨Ø¹ Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§ØªÙƒ.
        </p>
        <button class="btnPrimary bigBtn" onclick="initAuth()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        <p style="font-size:12px; opacity:.9;">
          Ù„Ùˆ Ø§Ù„Ø²Ø± Ù…Ø´ Ø´ØºØ§Ù„: Ø§ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ <b>Pi Browser</b>.
        </p>
      </div>

      <!-- APP -->
      <div id="app" style="display:none;">
        <div class="hero">
          <div class="heroTop">
            <div class="heroTitle">
              <small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ù…Ø­ÙÙˆØ¸</small>
              <strong>Ø±ØµÙŠØ¯ Ø§Ù„Ù€ Vault</strong>
            </div>
            <div class="chip" id="netChip">Pi Network</div>
          </div>

          <div class="balance">
            <div class="pi">Ï€</div>
            <div class="balNum" id="user-balance">0.00</div>
          </div>

          <div class="subRow">
            <div>Ø¢Ø®Ø± Payment ID</div>
            <div class="mono" id="last-payment">â€”</div>
          </div>
        </div>

        <div class="grid">
          <!-- Deposit -->
          <div class="card">
            <div class="cardHd">
              <h3>ğŸ“¥ Ø¥ÙŠØ¯Ø§Ø¹</h3>
              <div class="badge">Ø³Ø±ÙŠØ¹ Ø¨Ø¯ÙˆÙ† ØªØ¹Ù„ÙŠÙ‚</div>
            </div>
            <div class="cardBd">
              <div class="field">
                <div class="label">
                  <span>Ø§Ù„Ù…Ø¨Ù„Øº</span>
                  <span class="hint">Ø¨Ø§Ù„Ù€ Ï€</span>
                </div>
                <input id="d-amount" type="number" inputmode="decimal" step="0.01" min="0" placeholder="0.00">
              </div>

              <div class="btns">
                <button class="btnPrimary" id="btn-d" onclick="handleDeposit()">ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø±ØµÙŠØ¯</button>
                <button class="btnGhost" onclick="quickFill(1)">+1</button>
              </div>

              <div class="msg">
                <b>Ù…Ù„Ø§Ø­Ø¸Ø©:</b> approve/complete Ø¨ÙŠØªÙ†ÙØ°ÙˆØ§ Ø§Ù„Ø£ÙˆÙ„ Ø¹Ø´Ø§Ù† Ù…Ø§ ÙŠØ­ØµÙ„Ø´ ØªÙˆÙ‚Ù 60 Ø«Ø§Ù†ÙŠØ©ØŒ ÙˆØ¨Ø¹Ø¯Ù‡Ø§ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.
              </div>
            </div>
          </div>

          <!-- Withdraw -->
          <div class="card">
            <div class="cardHd">
              <h3>ğŸ“¤ Ø³Ø­Ø¨</h3>
              <div class="badge">Server Transfer</div>
            </div>
            <div class="cardBd">
              <div class="field">
                <div class="label">
                  <span>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©</span>
                  <span class="hint">G...</span>
                </div>
                <input id="w-addr" type="text" autocapitalize="off" autocomplete="off" spellcheck="false" placeholder="G...">
              </div>

              <div class="row">
                <div class="field" style="margin-bottom:0;">
                  <div class="label">
                    <span>Ø§Ù„ÙƒÙ…ÙŠØ©</span>
                    <span class="hint">Ø¨Ø§Ù„Ù€ Ï€</span>
                  </div>
                  <input id="w-amount" type="number" inputmode="decimal" step="0.01" min="0" placeholder="0.00">
                </div>
              </div>

              <div class="btns" style="margin-top:10px;">
                <button class="btnGhost" onclick="fillMax()">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰</button>
                <button class="btnPrimary" id="btn-w" onclick="handleWithdraw()">Ø³Ø­Ø¨ Ø§Ù„Ø¢Ù†</button>
              </div>

              <div class="msg">
                Ø§Ù„Ø³Ø­Ø¨ Ø¨ÙŠØªÙ†ÙØ° Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¹Ø¨Ø± <b>/api/withdraw</b> (Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø¹Ù†Ø¯Ùƒ withdraw.js Ø´ØºØ§Ù„ + Seed Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±).
              </div>
            </div>
          </div>

          <!-- History -->
          <div class="card">
            <div class="cardHd">
              <h3>ğŸ•’ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</h3>
              <div class="badge" id="histBadge">Ø¢Ø®Ø± 6</div>
            </div>
            <div class="cardBd">
              <div id="history-box" class="hist"></div>
              <div id="noHist" class="msg" style="display:none;">Ù„Ø³Ù‡ Ù…ÙÙŠØ´ Ø­Ø±ÙƒØ§Øª Ù‡Ù†Ø§.</div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="toast" id="toast">
    <div class="t1" id="toastT1">â€”</div>
    <div class="t2" id="toastT2">â€”</div>
  </div>

  <script>
    // =========================
    // Supabase
    // =========================
    const S_URL = 'https://xncapmzlwuisupkjlftb.supabase.co';
    const S_KEY = 'sb_publishable_zPECXAiI_bDbeLtRYe3vIw_IEt_p_AS';
    const _db = supabase.createClient(S_URL, S_KEY);

    // =========================
    // Pi
    // =========================
    const Pi = window.Pi;
    let user = null;
    let lastPaymentId = null;

    // =========================
    // UI Helpers
    // =========================
    const $ = (id) => document.getElementById(id);

    function toast(title, msg){
      $("toastT1").innerText = title || "";
      $("toastT2").innerText = msg || "";
      $("toast").classList.add("show");
      clearTimeout(window.__toastT);
      window.__toastT = setTimeout(()=> $("toast").classList.remove("show"), 3200);
    }

    function setBusy(btnId, busy){
      const b = $(btnId);
      if (!b) return;
      b.disabled = !!busy;
      b.style.opacity = busy ? .65 : 1;
    }

    function quickFill(x){
      const el = $("d-amount");
      const cur = parseFloat(el.value || "0") || 0;
      el.value = (cur + x).toFixed(2);
    }

    function fillMax(){
      const bal = parseFloat($("user-balance").innerText || "0") || 0;
      $("w-amount").value = bal > 0 ? bal.toFixed(2) : "";
    }

    function shortId(s){
      if(!s) return "â€”";
      if(s.length <= 18) return s;
      return s.slice(0,8) + "â€¦" + s.slice(-8);
    }

    function statusClass(st){
      const s = (st || "").toLowerCase();
      if(s === "completed" || s === "success") return "ok";
      if(s === "pending") return "pend";
      if(s === "failed" || s === "error") return "fail";
      return "";
    }

    function formatTime(iso){
      if(!iso) return "";
      const d = new Date(iso);
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const mo = String(d.getMonth()+1).padStart(2,'0');
      return `${dd}/${mo} ${hh}:${mm}`;
    }

    // =========================
    // Auth
    // =========================
    async function initAuth(){
      try{
        const auth = await Pi.authenticate(['username','payments'], onIncomplete);
        user = auth.user;

        $("login-box").style.display = "none";
        $("app").style.display = "block";
        $("userPill").style.display = "flex";
        $("u-name").innerText = `@${user.username}`;

        toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", `Ø£Ù‡Ù„Ù‹Ø§ ${user.username}`);
        await updateUI();
      }catch(e){
        alert("ÙŠØ¬Ø¨ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ù…Ù† Pi Browser");
      }
    }

    // =========================
    // IMPORTANT: FAST PAYMENT FLOW
    // - approve/complete FIRST (no DB waits)
    // - DB happens after and without blocking
    // =========================
    async function handleDeposit(){
      const val = parseFloat($("d-amount").value);
      if (!val || val <= 0) return toast("Ø®Ø·Ø£", "Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");

      setBusy("btn-d", true);

      const memo = "ØªØ¹Ø¨Ø¦Ø© Ø±ØµÙŠØ¯ Vault";
      const metadata = { action:"deposit", app:"PiVault" };

      try{
        await Pi.createPayment(
          { amount: val, memo, metadata },
          {
            onReadyForServerApproval: async (paymentId) => {
              lastPaymentId = paymentId;
              $("last-payment").innerText = shortId(paymentId);

              // 1) APPROVE FIRST (FAST)
              const res = await fetch('/api/pi/approve', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ paymentId })
              });

              co
