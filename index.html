<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi Life Simulation</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --primary: #6b3484; /* Ù„ÙˆÙ† Ø¨Ø§ÙŠ */
            --accent: #ffa500;
            --bg: #0f0c29;
        }

        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: var(--bg); font-family: 'Arial', sans-serif; overflow: hidden;
        }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #login-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
        }

        .card {
            background: white; padding: 30px; border-radius: 20px; text-align: center;
            box-shadow: 0 0 20px var(--accent);
        }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© HUD */
        #hud {
            position: absolute; top: 20px; left: 20px; right: 20px;
            display: flex; justify-content: space-between; pointer-events: none;
            z-index: 100;
        }

        .stat-box {
            background: rgba(0,0,0,0.6); color: white; padding: 10px 20px;
            border-radius: 50px; border: 2px solid var(--accent); pointer-events: auto;
            backdrop-filter: blur(5px);
        }

        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø± */
        #controls {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 15px; pointer-events: auto;
        }

        button {
            padding: 12px 25px; border-radius: 12px; border: none; cursor: pointer;
            font-weight: bold; transition: 0.3s;
        }

        .btn-action { background: var(--accent); color: #000; }
        .btn-pi { background: var(--primary); color: #white; color: white;}

        /* Ø§Ù„Ø¹Ø§Ù„Ù… */
        #game-world { width: 100vw; height: 100vh; cursor: crosshair; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="card">
            <h1 style="color: var(--primary)">Ø¹Ø§Ù„Ù… Pi Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</h1>
            <p>Ø§Ø¨Ù†Ù Ù…Ø³ØªÙ‚Ø¨Ù„ÙƒØŒ ØªØ¹Ù„Ù…ØŒ ÙˆØ§Ø³ØªØ«Ù…Ø± Ø¹Ù…Ù„Ø§ØªÙƒ</p>
            <button class="btn-pi" id="login-btn" style="font-size: 1.2rem;">Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Pi Network</button>
        </div>
    </div>

    <div id="hud" class="hidden">
        <div class="stat-box">
            ğŸ‘¤ <span id="user-name">...</span> | 
            â­ Ù…Ø³ØªÙˆÙŠ: <span id="user-level">1</span>
        </div>
        <div class="stat-box">
            ğŸ’° <span id="user-pi">0</span> Pi
        </div>
    </div>

    <div id="controls" class="hidden">
        <button class="btn-action" onclick="study()">ğŸ“š ØªØ¹Ù„Ù… (XP+)</button>
        <button class="btn-action" onclick="work()">ğŸ’¼ Ø¹Ù…Ù„ (Ø£Ù…ÙˆØ§Ù„ ÙˆÙ‡Ù…ÙŠØ©)</button>
        <button class="btn-pi" onclick="buyLand()">ğŸ—ï¸ Ø´Ø±Ø§Ø¡ Ø£Ø±Ø¶ (1 Pi)</button>
    </div>

    <canvas id="game-world"></canvas>

    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø¨Ø·
        const SUPABASE_URL = 'https://xncapmzlwuisupkjlftb.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_zPECXAiI_bDbeLtRYe3vIw_IEt_p_AS';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const Pi = window.Pi;
        let userData = {};

        // 1. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        document.getElementById('login-btn').onclick = async () => {
            try {
                const auth = await Pi.authenticate(['username', 'payments'], onIncompletePayment);
                initUser(auth.user);
            } catch (e) {
                alert("ÙŠØ±Ø¬Ù‰ ÙØªØ­ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ù† Ø¯Ø§Ø®Ù„ Ù…ØªØµÙØ­ Pi Browser");
            }
        };

        async function initUser(piUser) {
            // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Supabase
            let { data, error } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('username', piUser.username)
                .single();

            if (!data) {
                // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
                const { data: newUser } = await supabaseClient.from('profiles').insert([
                    { username: piUser.username, balance_pi: 0, level: 1, xp: 0 }
                ]).select().single();
                data = newUser;
            }

            userData = data;
            updateUI();
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('hud').classList.remove('hidden');
            document.getElementById('controls').classList.remove('hidden');
            startDrawing();
        }

        function updateUI() {
            document.getElementById('user-name').innerText = userData.username;
            document.getElementById('user-level').innerText = userData.level;
            document.getElementById('user-pi').innerText = userData.balance_pi;
        }

        // 2. Ù…ÙŠÙƒØ§Ù†ÙŠÙƒØ§ Ø§Ù„Ù„Ø¹Ø¨Ø©
        async function study() {
            userData.xp += 10;
            if(userData.xp >= 100) {
                userData.level += 1;
                userData.xp = 0;
                alert("ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ø§Ø±ØªÙ‚ÙŠØª Ù„Ù…Ø³ØªÙˆÙ‰ Ø¬Ø¯ÙŠØ¯");
            }
            await saveProgress();
            updateUI();
        }

        async function saveProgress() {
            await supabaseClient.from('profiles')
                .update({ xp: userData.xp, level: userData.level })
                .eq('username', userData.username);
        }

        // 3. Ø±Ø¨Ø· Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
        async function buyLand() {
            const payment = await Pi.createPayment({
                amount: 1,
                memo: "Ø´Ø±Ø§Ø¡ Ù‚Ø·Ø¹Ø© Ø£Ø±Ø¶ Ø§ÙØªØ±Ø§Ø¶ÙŠØ©",
                metadata: { type: "land_purchase" }
            }, {
                onReadyForServerApproval: (pid) => fetch('/api/pi/approve', {method:'POST', body: JSON.stringify({paymentId: pid})}),
                onReadyForServerCompletion: (pid, txid) => fetch('/api/pi/complete', {method:'POST', body: JSON.stringify({paymentId: pid, txid})}),
                onCancel: () => {},
                onError: (e) => console.error(e)
            });
        }

        // 4. Ø§Ù„Ø±Ø³ÙˆÙ…ÙŠØ§Øª (Canvas)
        const canvas = document.getElementById('game-world');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        function startDrawing() {
            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Ø±Ø³Ù… Ø§Ù„Ø´Ø®ØµÙŠØ© (Ù…Ø±Ø¨Ø¹ Ø°Ù‡Ø¨ÙŠ Ø¨Ø³ÙŠØ· Ø­Ø§Ù„ÙŠØ§Ù‹)
                ctx.fillStyle = "#ffa500";
                ctx.shadowBlur = 20;
                ctx.shadowColor = "#ffa500";
                ctx.fillRect(canvas.width/2 - 25, canvas.height/2 - 25, 50, 50);
                
                // ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù…
                ctx.shadowBlur = 0;
                ctx.fillStyle = "white";
                ctx.textAlign = "center";
                ctx.fillText(userData.username, canvas.width/2, canvas.height/2 - 40);

                requestAnimationFrame(draw);
            }
            draw();
        }

        function onIncompletePayment(p) { /* Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© */ }
    </script>
</body>
</html>
