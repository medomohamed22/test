<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi Vault Pro - Debug Mode</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --p: #7c3aed; --bg: #0f172a; --text: #f8fafc; }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; direction: rtl; }
        .card { background: rgba(255,255,255,0.05); border-radius: 15px; padding: 20px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; background: #1e293b; color: white; }
        button { width: 100%; padding: 14px; border-radius: 8px; border: none; background: var(--p); color: white; font-weight: bold; cursor: pointer; }
        button:disabled { background: #4b5563; }
        #log-container { background: #000; color: #00ff00; font-family: monospace; padding: 10px; border-radius: 8px; font-size: 12px; height: 150px; overflow-y: auto; margin-top: 20px; border: 1px solid #333; }
        .log-error { color: #ff4444; }
        .log-success { color: #44ff44; }
        .bal-box { text-align: center; font-size: 24px; margin-bottom: 20px; color: #facc15; }
    </style>
</head>
<body>

    <div class="bal-box">Ø±ØµÙŠØ¯Ùƒ: <span id="user-balance">0.00</span> Ï€</div>

    <div id="login-section">
        <button onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Pi</button>
    </div>

    <div id="app-section" style="display:none;">
        <div class="card">
            <h3>ğŸ“¥ Ø¥ÙŠØ¯Ø§Ø¹ (Donation)</h3>
            <input type="number" id="dep-amount" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ï€">
            <button id="btn-dep" onclick="handleDeposit()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹</button>
        </div>

        <div class="card">
            <h3>ğŸ“¤ Ø³Ø­Ø¨ (Withdraw)</h3>
            <input type="text" id="with-address" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø© G...">
            <input type="number" id="with-amount" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
            <button id="btn-with" onclick="handleWithdraw()" style="background: #334155;">Ø·Ù„Ø¨ Ø³Ø­Ø¨</button>
        </div>
    </div>

    <h4>ğŸ›  Ø³Ø¬Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… (Logs):</h4>
    <div id="log-container"></div>

<script>
    const SUPABASE_URL = 'https://xncapmzlwuisupkjlftb.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_zPECXAiI_bDbeLtRYe3vIw_IEt_p_AS';
    const _db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    let user = null;

    // Ø¯Ø§Ù„Ø© Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù€ Logs Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©
    function addLog(msg, type = 'info') {
        const logBox = document.getElementById('log-container');
        const time = new Date().toLocaleTimeString();
        const colorClass = type === 'error' ? 'log-error' : (type === 'success' ? 'log-success' : '');
        logBox.innerHTML += `<div class="${colorClass}">[${time}] ${msg}</div>`;
        logBox.scrollTop = logBox.scrollHeight;
    }

    async function login() {
        try {
            addLog("Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...");
            const Pi = window.Pi;
            Pi.init({ version: "2.0" });
            const auth = await Pi.authenticate(['username', 'payments'], onIncomplete);
            user = auth.user;
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('app-section').style.display = 'block';
            addLog(`Ø£Ù‡Ù„Ø§Ù‹ @${user.username}`, 'success');
            refreshBalance();
        } catch (e) {
            addLog("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + e.message, 'error');
        }
    }

    async function refreshBalance() {
        try {
            const { data: d } = await _db.from('donations').select('amount').eq('pi_user_id', user.uid);
            const { data: w } = await _db.from('withdrawals').select('amount').eq('pi_user_id', user.uid);
            const totalIn = d?.reduce((a, b) => a + parseFloat(b.amount), 0) || 0;
            const totalOut = w?.reduce((a, b) => a + parseFloat(b.amount), 0) || 0;
            document.getElementById('user-balance').innerText = (totalIn - totalOut).toFixed(2);
            addLog("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©");
        } catch (e) {
            addLog("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø±ØµÙŠØ¯: " + e.message, 'error');
        }
    }

    async function handleDeposit() {
        const amt = document.getElementById('dep-amount').value;
        if (!amt) return addLog("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹", 'error');
        
        const btn = document.getElementById('btn-dep');
        btn.disabled = true;

        try {
            addLog(`Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø¯ÙØ¹ Ù„Ù…Ø¨Ù„Øº ${amt} Ï€...`);
            await window.Pi.createPayment({
                amount: parseFloat(amt),
                memo: "Deposit to Vault",
                metadata: { action: "deposit" }
            }, {
                onReadyForServerApproval: (id) => {
                    addLog("Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø³ÙŠØ±ÙØ± (Approve)...");
                    return fetch('/api/pi/approve', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ paymentId: id })
                    }).then(res => res.json());
                },
                onReadyForServerCompletion: async (id, txid) => {
                    addLog(`ØªÙ… Ø§Ù„Ø¯ÙØ¹! Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: ${txid.slice(0,10)}...`);
                    
                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Supabase
                    addLog("Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø¬Ø¯ÙˆÙ„ donations...");
                    const { error } = await _db.from('donations').insert([
                        { pi_user_id: user.uid, username: user.username, amount: amt, payment_id: id }
                    ]);

                    if (error) {
                        addLog("ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Supabase: " + error.message, 'error');
                    } else {
                        addLog("ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ…", 'success');
                    }

                    await fetch('/api/pi/complete', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ paymentId: id, txid: txid })
                    });

                    btn.disabled = false;
                    refreshBalance();
                },
                onCancel: () => { addLog("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯ÙØ¹ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"); btn.disabled = false; },
                onError: (e) => { addLog("Ø®Ø·Ø£ ÙÙŠ Pi SDK: " + e.message, 'error'); btn.disabled = false; }
            });
        } catch (e) {
            addLog("Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: " + e.message, 'error');
            btn.disabled = false;
        }
    }

    async function handleWithdraw() {
        const addr = document.getElementById('with-address').value;
        const amt = document.getElementById('with-amount').value;
        const bal = parseFloat(document.getElementById('user-balance').innerText);

        if (!addr || !amt) return addLog("Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø¨", 'error');
        if (parseFloat(amt) > bal) return addLog("Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ!", 'error');

        addLog("Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨...");
        try {
            const { error } = await _db.from('withdrawals').insert([
                { pi_user_id: user.uid, username: user.username, amount: amt, wallet_address: addr }
            ]);

            if (error) throw error;

            addLog("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ withdrawals. Ø¬Ø§Ø±ÙŠ Ø¥Ø®Ø·Ø§Ø± Ø§Ù„Ø³ÙŠØ±ÙØ±...");
            
            const res = await fetch('/api/withdraw', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ uid: user.uid, amount: amt, address: addr })
            });

            if (res.ok) {
                addLog("ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­!", 'success');
                refreshBalance();
            } else {
                addLog("ÙØ´Ù„ Ø§Ù„Ø³Ø­Ø¨ Ù…Ù† Ø¬Ù‡Ø© Ø§Ù„Ø³ÙŠØ±ÙØ± (ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù€ Seed)", 'error');
            }
        } catch (e) {
            addLog("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³Ø­Ø¨: " + e.message, 'error');
        }
    }

    async function onIncomplete(p) {
        addLog("ÙˆØ¬Ø¯Ù†Ø§ Ø¹Ù…Ù„ÙŠØ© Ø¯ÙØ¹ Ù…Ø¹Ù„Ù‚Ø©ØŒ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ù‡Ø§Ø¦Ù‡Ø§...");
        fetch('/api/pi/complete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ paymentId: p.identifier, txid: p.transaction.txid })
        });
    }
</script>
</body>
</html>
