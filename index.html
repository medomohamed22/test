<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nexus Wallet</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #6c5ce7;
            --dark-bg: #0f172a;
            --glass: rgba(255, 255, 255, 0.05);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; transition: all 0.3s ease; }
        body { 
            background: var(--dark-bg); color: white; 
            font-family: 'Inter', 'Tajawal', sans-serif; 
            min-height: 100vh; padding: 20px; 
        }

        /* ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿØÿÆŸàŸÑ ŸàÿßŸÑÿ¥ÿπÿßÿ± ÿßŸÑÿπÿßÿ¶ŸÖ */
        #login-overlay {
            position: fixed; inset: 0; background: var(--dark-bg);
            z-index: 9999; display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
        }

        .floating-pi {
            width: 100px; height: 100px;
            background: var(--primary);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem; font-weight: bold; color: white;
            box-shadow: 0 0 30px var(--primary);
            animation: float 4s ease-in-out infinite;
            margin-bottom: 30px;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(10deg); }
        }

        /* ÿ≤ÿ± ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑŸÑÿ∫ÿ© */
        .lang-switch {
            position: fixed; top: 20px; right: 20px;
            background: var(--glass); border: 1px solid rgba(255,255,255,0.1);
            color: white; padding: 10px 15px; border-radius: 50px;
            cursor: pointer; z-index: 10000; font-size: 1.2rem;
        }

        /* ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© */
        .vault-card {
            background: linear-gradient(135deg, var(--primary), #a29bfe);
            border-radius: 24px; padding: 30px; height: 200px;
            display: flex; flex-direction: column; justify-content: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3); margin-top: 50px;
        }

        .balance-label { font-size: 0.9rem; opacity: 0.8; margin-bottom: 5px; }
        .balance-value { font-size: 2.8rem; font-weight: 700; }

        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 30px 0; }
        .action-btn {
            background: var(--glass); border: 1px solid rgba(255,255,255,0.1);
            padding: 20px; border-radius: 20px; text-align: center; cursor: pointer;
        }

        /* ÿßŸÑŸÖŸàÿØÿßŸÑ */
        .modal {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(10px);
            z-index: 1000; justify-content: center; align-items: flex-end;
        }
        .modal-content {
            background: #1e293b; width: 100%; border-radius: 30px 30px 0 0;
            padding: 40px 25px;
        }

        input {
            width: 100%; background: #0f172a; border: 1px solid #334155;
            padding: 15px; border-radius: 15px; color: white; margin-bottom: 15px;
            text-align: center; font-size: 1.1rem;
        }

        .confirm-btn {
            width: 100%; padding: 16px; border-radius: 15px; border: none;
            background: var(--primary); color: white; font-weight: 700;
        }

        .history-section { background: var(--glass); border-radius: 25px; padding: 20px; }
        .history-item {
            display: flex; justify-content: space-between; padding: 15px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        /* RTL Support */
        [dir="rtl"] .lang-switch { right: auto; left: 20px; }
    </style>
</head>
<body dir="ltr">

    <button class="lang-switch" onclick="toggleLang()">üåê</button>

    <div id="login-overlay">
        <div class="floating-pi">œÄ</div>
        <h1 id="t-welcome">Nexus Wallet</h1>
        <p id="t-subwelcome" style="opacity: 0.6; margin: 15px 0 30px;">Secure your Pi Assets</p>
        <button onclick="login()" class="confirm-btn" style="width: 200px;" id="t-login-btn">Secure Login</button>
    </div>

    <div class="vault-card">
        <div class="balance-label" id="t-balance-label">Available Balance</div>
        <div class="balance-value"><span id="main-balance">0.00</span> <span style="font-size: 1.2rem;">œÄ</span></div>
        <div id="user-display" style="margin-top: 15px; opacity: 0.7; font-size: 0.9rem;"></div>
    </div>

    <div class="action-grid">
        <div class="action-btn" onclick="openModal('deposit')">
            <span id="t-deposit-btn">üì• Deposit</span>
        </div>
        <div class="action-btn" onclick="openModal('withdraw')">
            <span id="t-withdraw-btn">üì§ Withdraw</span>
        </div>
    </div>

    <div class="history-section">
        <h4 id="t-history-title" style="margin-bottom: 15px; opacity: 0.7;">Recent Activity</h4>
        <div id="history-list"></div>
    </div>

    <div id="deposit-modal" class="modal" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 id="t-dep-title" style="margin-bottom: 20px; text-align: center;">Deposit Pi</h2>
            <input type="number" id="dep-amount" placeholder="Amount œÄ">
            <button id="btn-dep" class="confirm-btn" onclick="executeDeposit()">Confirm Deposit</button>
        </div>
    </div>

    <div id="withdraw-modal" class="modal" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 id="t-wit-title" style="margin-bottom: 20px; text-align: center;">Withdraw Pi</h2>
            <input type="text" id="wit-address" placeholder="Wallet Address G...">
            <input type="number" id="wit-amount" placeholder="Amount">
            <button id="btn-wit" class="confirm-btn" style="background: #ef4444;" onclick="executeWithdraw()">Confirm Withdrawal</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://xncapmzlwuisupkjlftb.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_zPECXAiI_bDbeLtRYe3vIw_IEt_p_AS';
        const _db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let user = null;
        let currentLang = 'en';

        const i18n = {
            en: {
                welcome: "Nexus Wallet", sub: "Secure your Pi Assets", login: "Secure Login",
                bal_lbl: "Available Balance", dep: "üì• Deposit", wit: "üì§ Withdraw",
                hist: "Recent Activity", dep_t: "Deposit Pi", wit_t: "Withdraw Pi",
                conf_dep: "Confirm Deposit", conf_wit: "Confirm Withdrawal",
                success_dep: "Deposit Successful!", success_wit: "Withdrawal Requested!",
                wait: "Processing...", low_bal: "Insufficient balance"
            },
            ar: {
                welcome: "ŸÖÿ≠ŸÅÿ∏ÿ© ŸÜŸäŸÉÿ≥Ÿàÿ≥", sub: "ÿ£ŸÖŸÜ ÿ£ÿµŸàŸÑŸÉ ŸÖŸÜ ÿπŸÖŸÑÿ© ÿ®ÿßŸä", login: "ÿØÿÆŸàŸÑ ÿ¢ŸÖŸÜ",
                bal_lbl: "ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ≠", dep: "üì• ÿ•ŸäÿØÿßÿπ", wit: "üì§ ÿ≥ÿ≠ÿ®",
                hist: "ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ£ÿÆŸäÿ±ÿ©", dep_t: "ÿ•ŸäÿØÿßÿπ ÿ®ÿßŸä", wit_t: "ÿ≥ÿ≠ÿ® ÿ®ÿßŸä",
                conf_dep: "ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ•ŸäÿØÿßÿπ", conf_wit: "ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≥ÿ≠ÿ®",
                success_dep: "ÿ™ŸÖ ÿßŸÑÿ•ŸäÿØÿßÿπ ÿ®ŸÜÿ¨ÿßÿ≠!", success_wit: "ÿ™ŸÖ ÿ∑ŸÑÿ® ÿßŸÑÿ≥ÿ≠ÿ®!",
                wait: "ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©...", low_bal: "ÿßŸÑÿ±ÿµŸäÿØ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸç"
            }
        };

        function toggleLang() {
            currentLang = currentLang === 'en' ? 'ar' : 'en';
            document.body.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
            const t = i18n[currentLang];
            document.getElementById('t-welcome').innerText = t.welcome;
            document.getElementById('t-subwelcome').innerText = t.sub;
            document.getElementById('t-login-btn').innerText = t.login;
            document.getElementById('t-balance-label').innerText = t.bal_lbl;
            document.getElementById('t-deposit-btn').innerText = t.dep;
            document.getElementById('t-withdraw-btn').innerText = t.wit;
            document.getElementById('t-history-title').innerText = t.hist;
            document.getElementById('t-dep-title').innerText = t.dep_t;
            document.getElementById('t-wit-title').innerText = t.wit_t;
            document.getElementById('btn-dep').innerText = t.conf_dep;
            document.getElementById('btn-wit').innerText = t.conf_wit;
        }

        async function login() {
            try {
                const auth = await window.Pi.authenticate(['username', 'payments'], onIncomplete);
                user = auth.user;
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('user-display').innerText = `@${user.username}`;
                refreshData();
            } catch (e) { alert("Use Pi Browser"); }
        }

        async function refreshData() {
            if (!user) return;
            const { data: d } = await _db.from('donations').select('*').eq('pi_user_id', user.uid);
            const { data: w } = await _db.from('withdrawals').select('*').eq('pi_user_id', user.uid);
            
            const totalIn = d?.reduce((s, r) => s + parseFloat(r.amount), 0) || 0;
            const totalOut = w?.reduce((s, r) => s + parseFloat(r.amount), 0) || 0;
            document.getElementById('main-balance').innerText = (totalIn - totalOut).toFixed(2);
            
            const list = document.getElementById('history-list');
            const all = [...(d || []), ...(w || [])].sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
            list.innerHTML = all.slice(0, 5).map(i => `
                <div class="history-item">
                    <span>${i.wallet_address ? i18n[currentLang].wit : i18n[currentLang].dep}</span>
                    <span style="color:${i.wallet_address ? '#ff7675' : '#55efc4'}">${i.wallet_address?'-':'+'}${parseFloat(i.amount).toFixed(2)}</span>
                </div>
            `).join('');
        }

        async function executeDeposit() {
            const amt = parseFloat(document.getElementById('dep-amount').value);
            if (!amt || amt <= 0) return;
            const btn = document.getElementById('btn-dep');
            btn.disabled = true; btn.innerText = i18n[currentLang].wait;

            try {
                await window.Pi.createPayment({ amount: amt, memo: "Deposit to Nexus Wallet", metadata: { type: "deposit" } }, {
                    onReadyForServerApproval: (id) => fetch('/api/pi/approve', { method: 'POST', body: JSON.stringify({ paymentId: id }) }),
                    onReadyForServerCompletion: async (id, txid) => {
                        await _db.from('donations').insert([{ pi_user_id: user.uid, username: user.username, amount: amt, payment_id: id }]);
                        await fetch('/api/pi/complete', { method: 'POST', body: JSON.stringify({ paymentId: id, txid: txid }) });
                        alert(i18n[currentLang].success_dep);
                        closeAllModals();
                        refreshData(); 
                    },
                    onCancel: () => { btn.disabled = false; btn.innerText = i18n[currentLang].conf_dep; },
                    onError: () => { btn.disabled = false; }
                });
            } catch (e) { btn.disabled = false; }
        }

        async function executeWithdraw() {
            const addr = document.getElementById('wit-address').value;
            const amt = parseFloat(document.getElementById('wit-amount').value);
            const bal = parseFloat(document.getElementById('main-balance').innerText);

            if (!addr || amt <= 0) return;
            if (amt > bal) return alert(i18n[currentLang].low_bal);

            const btn = document.getElementById('btn-wit');
            btn.disabled = true; btn.innerText = i18n[currentLang].wait;

            try {
                const res = await fetch('/api/withdraw', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ uid: user.uid, username: user.username, amount: amt, walletAddress: addr })
                });
                if (res.ok) {
                    alert(i18n[currentLang].success_wit);
                    closeAllModals();
                    refreshData();
                } else {
                    const err = await res.json();
                    alert(err.details);
                }
            } catch (e) { alert("Server Error"); }
            btn.disabled = false;
        }

        function openModal(type) { document.getElementById(`${type}-modal`).style.display = 'flex'; }
        function closeModal(e) { e.target.style.display = 'none'; }
        function closeAllModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
        async function onIncomplete(p) { fetch('/api/pi/complete', { method: 'POST', body: JSON.stringify({ paymentId: p.identifier, txid: p.transaction.txid }) }); }
        window.onload = () => { window.Pi.init({version: "2.0"}); };
    </script>
</body>
</html>
