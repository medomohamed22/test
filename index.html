<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi Payment System</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    
    <style>
        :root {
            --pi-purple: #673ab7;
            --pi-gold: #ffa000;
            --bg-color: #f8f9fa;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .header h1 { color: var(--pi-purple); margin-bottom: 5px; }
        .header p { color: #666; font-size: 14px; margin-top: 0; }

        .user-card {
            background: #f0ebf8;
            padding: 15px;
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid #d1c4e9;
        }

        .balance-info {
            font-size: 18px;
            font-weight: bold;
            color: var(--pi-purple);
            margin: 10px 0;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-pay {
            background-color: var(--pi-purple);
            color: white;
        }

        .btn-pay:disabled { background-color: #ccc; cursor: not-allowed; }

        .btn-withdraw {
            background-color: white;
            color: var(--pi-gold);
            border: 2px solid var(--pi-gold);
        }

        .btn-withdraw:hover { background-color: #fff8e1; }

        #status-message {
            margin-top: 15px;
            font-size: 13px;
            padding: 10px;
            border-radius: 8px;
        }

        .success { color: #2e7d32; background: #e8f5e9; }
        .error { color: #c62828; background: #ffebee; }
        .info { color: #1565c0; background: #e3f2fd; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>Pi Wallet App</h1>
            <p>نظام الدفع والسحب المتكامل</p>
        </div>

        <div id="auth-section">
            <div class="user-card">
                <div id="loading">جاري فحص الهوية...</div>
                <div id="user-info" style="display: none;">
                    <span>مرحباً: </span><strong id="username">--</strong>
                    <div class="balance-info">الرصيد الافتراضي: <span id="balance">10.00</span> Pi</div>
                </div>
            </div>
        </div>

        <button id="btn-pay" class="btn btn-pay" disabled>دفع 1 Pi للتطبيق</button>
        <button id="btn-withdraw" class="btn btn-withdraw" disabled>سحب 1 Pi إلى محفظتي</button>

        <div id="status-message"></div>
    </div>

    <script>
        const Pi = window.Pi;
        let currentUser = null;

        // تهيئة الـ SDK
        Pi.init({ version: "2.0", sandbox: false });

        // 1. وظيفة المصادقة
        async function login() {
            try {
                const scopes = ['username', 'payments', 'wallet_address'];
                currentUser = await Pi.authenticate(scopes, onIncompletePaymentFound);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('user-info').style.display = 'block';
                document.getElementById('username').innerText = currentUser.user.username;
                
                // تفعيل الأزرار
                document.getElementById('btn-pay').disabled = false;
                document.getElementById('btn-withdraw').disabled = false;
                
                showStatus("تم تسجيل الدخول بنجاح", "info");
            } catch (err) {
                showStatus("يرجى فتح التطبيق من داخل Pi Browser", "error");
            }
        }

        // 2. معالجة المدفوعات غير المكتملة (مطلوب من Pi)
        function onIncompletePaymentFound(payment) {
            console.log("وجدنا عملية معلقة:", payment);
        }

        // 3. عملية الدفع (من المستخدم للتطبيق User-to-App)
        async function startPayment() {
            showStatus("جاري فتح المحفظة...", "info");
            
            Pi.createPayment({
                amount: 1.0,
                memo: "شراء خدمات رقمية",
                metadata: { type: "deposit" }
            }, {
                onReadyForServerApproval: (paymentId) => {
                    return fetch('/api/pi/approve', {
                        method: 'POST',
                        body: JSON.stringify({ paymentId })
                    });
                },
                onReadyForServerCompletion: (paymentId, txid) => {
                    return fetch('/api/pi/complete', {
                        method: 'POST',
                        body: JSON.stringify({ paymentId, txid })
                    }).then(() => {
                        showStatus("✅ تم استلام المبلغ بنجاح!", "success");
                    });
                },
                onCancel: (paymentId) => showStatus("تم إلغاء العملية", "info"),
                onError: (error) => showStatus("خطأ: " + error.message, "error")
            });
        }

        // 4. عملية السحب (من التطبيق للمستخدم App-to-User)
        async function startWithdraw() {
            showStatus("جاري إرسال الطلب للسيرفر...", "info");

            try {
                const response = await fetch('/api/pi/withdraw', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount: 1.0,
                        userId: currentUser.user.uid, // المعرف الفريد للمستخدم
                        walletAddress: "" // اختياري حسب إعدادات السيرفر لديك
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showStatus("✅ تم تحويل 1 Pi إلى محفظتك!", "success");
                } else {
                    showStatus("❌ فشل السحب: " + (result.error.message || "خطأ داخلي"), "error");
                }
            } catch (err) {
                showStatus("فشل الاتصال بالسيرفر", "error");
            }
        }

        // دالة مساعدة لإظهار الرسائل
        function showStatus(msg, type) {
            const el = document.getElementById('status-message');
            el.innerText = msg;
            el.className = type;
        }

        // ربط الأحداث بالأزرار
        document.getElementById('btn-pay').onclick = startPayment;
        document.getElementById('btn-withdraw').onclick = startWithdraw;

        // تنفيذ الدخول عند تحميل الصفحة
        login();
    </script>
</body>
</html>
